<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHARLES Hub</title>
  <script src="https://unpkg.com/muuri@0.9.5/dist/muuri.min.js"></script>
  <style>
    :root {
      --bg: #030c0a;
      --panel: #0d1512;
      --border: #1f312c;
      --text: #d8f5e5;
      --muted: #8aa59b;
      --accent: #32ff8c;
      --shadow: 0 0 18px rgba(50, 255, 140, 0.12);
      --gap: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px 10px 24px;
      background: radial-gradient(circle at 20% 20%, #0b1612, #040805 65%);
      color: var(--text);
      font-family: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      line-height: 1.5;
    }
    h1 {
      margin: 0 0 14px;
      font-size: 1.3rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      text-shadow: 0 0 12px rgba(50, 255, 140, 0.45);
    }
    .grid {
      position: relative;
      max-width: 1500px;
      margin: 0 auto;
      padding: var(--gap);
      min-height: 60vh;
    }
    .item {
      box-sizing: border-box;
      position: absolute;
      width: calc(33.333% - var(--gap));
      padding: calc(var(--gap) / 2);
      margin: 0;
    }
    .item-content {
      position: relative;
      width: 100%;
    }
    @media (max-width: 1300px) { .item { width: calc(50% - var(--gap)); } }
    @media (max-width: 900px) { .item { width: calc(100% - var(--gap)); } }
    @media (max-width: 600px) { .item { width: calc(100% - var(--gap)); position: relative; } }
    .item.muuri-item-dragging { z-index: 20; }
    .item.muuri-item-releasing { z-index: 10; }
    .item.muuri-item-hidden { z-index: 0; }
    .item.muuri-item-placeholder { z-index: 5; }
    .item.muuri-item-placeholder .item-content {
      width: 100%;
    }
    .item.muuri-item-placeholder .card {
      opacity: 0.25;
      border: 1px dashed var(--accent);
      box-shadow: none;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 14px 16px;
      box-shadow: var(--shadow);
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      color: var(--accent);
      text-transform: uppercase;
    }
    .card h3.inline {
      margin: 4px 0;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 400;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      gap: 8px;
    }
    .card-body {
      margin-top: 2px;
    }
    label {
      display: block;
      font-size: 0.86rem;
      color: var(--muted);
      margin: 8px 0 4px;
    }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      background: #0b1311;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
    }
    textarea { min-height: 140px; resize: vertical; }
    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }
    button {
      background: var(--accent);
      color: #03120b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(38, 195, 106, 0.25);
      transition: transform 0.08s ease, box-shadow 0.15s ease;
    }
    button.secondary {
      background: #0f1c16;
      color: var(--text);
      box-shadow: none;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .note { font-size: 0.82rem; color: var(--muted); margin-top: 6px; }
    .feed {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: #0a120f;
      font-size: 0.9rem;
    }
    .feed .entry { margin: 0 0 8px; }
    .feed .entry:last-child { margin-bottom: 0; }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(50,255,140,0.08);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.9rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      font-size: 0.88rem;
      color: var(--text);
    }
    th {
      text-align: left;
      color: var(--accent);
      letter-spacing: 0.04em;
    }
    td.checkbox-cell {
      text-align: center;
      width: 70px;
    }
    td.checkbox-cell input {
      transform: scale(1.1);
    }
    .table-wrap {
      background: #0b1311;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 6px 4px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <h1>CHARLES Hub</h1>
  <div class="grid" id="card-grid">
    <div class="item" data-id="persona">
      <div class="item-content">
      <div class="card" data-card="persona">
        <div class="card-header">
          <h2>Persona</h2>
        </div>
        <div class="card-body" id="body-persona">
          <label for="persona">Prompt</label>
          <textarea id="persona"></textarea>
          <h3 style="margin-top:12px; color: var(--accent); letter-spacing:0.04em; text-transform: uppercase; font-size:0.9rem;">Prompt Pools</h3>
          <label for="news_urls">News URLs (one per line)</label>
          <textarea id="news_urls"></textarea>
          <button onclick="saveState()">Save persona</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="routing">
      <div class="item-content">
      <div class="card" data-card="routing">
        <div class="card-header">
          <h2>Routing & Notify</h2>
        </div>
        <div class="card-body" id="body-routing">
      <label for="route_default">Default route</label>
      <select id="route_default">
        <option value="both">both</option>
        <option value="feed">feed</option>
        <option value="notify">notify</option>
        <option value="none">none</option>
      </select>
      <label for="throttle_seconds">Throttle seconds</label>
      <input type="number" id="throttle_seconds" min="0" step="10">
      <div class="toggle"><input type="checkbox" id="feed_enabled"><label for="feed_enabled">Feed enabled</label></div>
      <div class="toggle"><input type="checkbox" id="notifications_enabled"><label for="notifications_enabled">Notifications enabled</label></div>
      <label for="notify_service">Notify service</label>
      <input type="text" id="notify_service" placeholder="notify.mobile_app_pixel_9">
      <label for="notify_title">Notify title</label>
      <input type="text" id="notify_title" placeholder="CHARLES says">
      <label for="notify_tag">Notify tag</label>
      <input type="text" id="notify_tag" placeholder="charles_stream">
      <h3 style="margin-top:12px; color: var(--accent); letter-spacing:0.04em; text-transform: uppercase; font-size:0.9rem;">Quiet Hours</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
        <div><label for="quiet_start">Start</label><input type="time" id="quiet_start" value="22:00"></div>
        <div><label for="quiet_end">End</label><input type="time" id="quiet_end" value="07:00"></div>
      </div>
      <button onclick="saveState()">Save routing</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="domains">
      <div class="item-content">
      <div class="card" data-card="domains">
        <div class="card-header">
          <h2>Domains</h2>
        </div>
        <div class="card-body" id="body-domains">
      <label style="margin-bottom:4px;">Categories</label>
      <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Category</th><th class="checkbox-cell">Notify</th><th class="checkbox-cell">Feed</th><th class="checkbox-cell"></th></tr>
        </thead>
        <tbody>
          <tr><td>Weather</td><td class="checkbox-cell"><input type="checkbox" id="cat_weather"></td><td class="checkbox-cell"><input type="checkbox" id="feed_weather"></td><td class="checkbox-cell"><button class="secondary" id="btn-weather" onclick="toggleDetails('weather')">▼</button></td></tr>
          <tr id="row-weather" style="display:none;">
            <td colspan="4">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="weather_gap">Min gap (sec)</label><input type="number" id="weather_gap" min="0" step="60"></div>
                <div><label for="weather_delta">Temp delta (°)</label><input type="number" id="weather_delta" min="0" step="1"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="weather_condition"><label for="weather_condition">Only on condition change</label></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="weather_feed_only_minor"><label for="weather_feed_only_minor">Minor changes: feed only</label></div>
              </div>
            </td>
          </tr>
          <tr><td>Calendar</td><td class="checkbox-cell"><input type="checkbox" id="cat_calendar"></td><td class="checkbox-cell"><input type="checkbox" id="feed_calendar"></td><td class="checkbox-cell"><button class="secondary" id="btn-calendar" onclick="toggleDetails('calendar')">▼</button></td></tr>
          <tr id="row-calendar" style="display:none;">
            <td colspan="4">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                <div><label for="calendar_lead">Lead time (min)</label><input type="number" id="calendar_lead" min="0" step="5"></div>
                <div><label for="calendar_poll">Poll every (sec)</label><input type="number" id="calendar_poll" min="60" step="30"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="calendar_morning_enabled"><label for="calendar_morning_enabled">Morning brief</label></div>
                <div><label for="calendar_morning_time">Morning time</label><input type="time" id="calendar_morning_time" value="07:30"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="calendar_evening_enabled"><label for="calendar_evening_enabled">Evening brief</label></div>
                <div><label for="calendar_evening_time">Evening time</label><input type="time" id="calendar_evening_time" value="21:00"></div>
              </div>
              <label for="calendar_entities" style="margin-top:8px;">Calendars (entity ids, one per line)</label>
              <textarea id="calendar_entities" placeholder="calendar.family&#10;calendar.work"></textarea>
            </td>
          </tr>
          <tr><td>System</td><td class="checkbox-cell"><input type="checkbox" id="cat_system"></td><td class="checkbox-cell"><input type="checkbox" id="feed_system"></td><td></td></tr>
          <tr><td>Vacuum</td><td class="checkbox-cell"><input type="checkbox" id="cat_vacuum"></td><td class="checkbox-cell"><input type="checkbox" id="feed_vacuum"></td><td></td></tr>
          <tr><td>Lighting</td><td class="checkbox-cell"><input type="checkbox" id="cat_lighting"></td><td class="checkbox-cell"><input type="checkbox" id="feed_lighting"></td><td></td></tr>
          <tr><td>Arrivals</td><td class="checkbox-cell"><input type="checkbox" id="cat_arrivals"></td><td class="checkbox-cell"><input type="checkbox" id="feed_arrivals"></td><td></td></tr>
          <tr><td>People</td><td class="checkbox-cell"><input type="checkbox" id="cat_people"></td><td class="checkbox-cell"><input type="checkbox" id="feed_people"></td><td></td></tr>
          <tr>
            <td>Musings</td><td class="checkbox-cell"><input type="checkbox" id="cat_musings"></td><td class="checkbox-cell"><input type="checkbox" id="feed_musings"></td>
            <td class="checkbox-cell"><button class="secondary" id="btn-musings" onclick="toggleDetails('musings')">▼</button></td>
          </tr>
          <tr id="row-musings" style="display:none;">
            <td colspan="4">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="musing_min">Min (min)</label><input type="number" id="musing_min" min="1" step="5"></div>
                <div><label for="musing_max">Max (min)</label><input type="number" id="musing_max" min="1" step="5"></div>
                <div><label for="musing_cap">Daily cap</label><input type="number" id="musing_cap" min="0" step="1"></div>
              </div>
              <label for="musing_pool" style="margin-top:8px;">Musings (one per line)</label>
              <textarea id="musing_pool"></textarea>
            </td>
          </tr>
          <tr>
            <td>Jokes</td><td class="checkbox-cell"><input type="checkbox" id="cat_jokes"></td><td class="checkbox-cell"><input type="checkbox" id="feed_jokes"></td>
            <td class="checkbox-cell"><button class="secondary" id="btn-jokes" onclick="toggleDetails('jokes')">▼</button></td>
          </tr>
          <tr id="row-jokes" style="display:none;">
            <td colspan="4">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="joke_min">Min (min)</label><input type="number" id="joke_min" min="1" step="5"></div>
                <div><label for="joke_max">Max (min)</label><input type="number" id="joke_max" min="1" step="5"></div>
                <div><label for="joke_cap">Daily cap</label><input type="number" id="joke_cap" min="0" step="1"></div>
              </div>
              <label for="joke_pool" style="margin-top:8px;">Jokes (one per line)</label>
              <textarea id="joke_pool"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
      </div>
      <button style="margin-top:10px;" onclick="saveState()">Save domains</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="emit">
      <div class="item-content">
      <div class="card" data-card="emit">
        <div class="card-header">
          <h2>Emit Test</h2>
        </div>
        <div class="card-body" id="body-emit">
      <label for="emit_topic">Topic</label>
      <input type="text" id="emit_topic" value="general">
      <label for="emit_category">Category</label>
      <input type="text" id="emit_category" value="system">
      <label for="emit_context">Context</label>
      <textarea id="emit_context">All systems nominal.</textarea>
      <label for="emit_route">Route</label>
      <select id="emit_route">
        <option value="default">default</option>
        <option value="both">both</option>
        <option value="feed">feed</option>
        <option value="notify">notify</option>
        <option value="none">none</option>
      </select>
      <button onclick="emit()">Send emit</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="feed">
      <div class="item-content">
      <div class="card" data-card="feed">
        <div class="card-header">
          <h2>Feed</h2>
        </div>
        <div class="card-body" id="body-feed">
      <div class="note" id="feed-meta">Loading feed…</div>
      <div class="feed" id="feed"></div>
      <div class="note" id="unread-meta">Unread: 0</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary" onclick="loadFeed()">Refresh feed</button>
        <button class="secondary" onclick="markRead()">Mark read</button>
        <button class="secondary" onclick="toggleAutoFeed()" id="auto-btn">Auto-refresh</button>
      </div>
      <div class="note" id="unread-log"></div>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="health">
      <div class="item-content">
      <div class="card" data-card="health">
        <div class="card-header">
          <h2>Health</h2>
        </div>
        <div class="card-body" id="body-health">
          <div class="note" id="health-status">Loading…</div>
          <div class="note" id="health-last"></div>
          <div class="note" id="health-next"></div>
          <div class="note" id="health-calendar"></div>
          <div class="note" id="health-error"></div>
          <button class="secondary" onclick="loadHealth()">Refresh health</button>
        </div>
      </div>
      </div>
    </div>
  </div>
  <div class="status" id="status">Loading…</div>

  <script>
    let currentState = {};
    const api = (path, opts={}) => {
      const url = path.startsWith('/') ? '.' + path : path;
      return fetch(url, opts);
    };
    const orderKey = 'charles_cards_order';
    let gridMuuri = null;
    const reflowGrid = () => {
      if (!gridMuuri) return;
      gridMuuri.refreshItems();
      gridMuuri.layout(true);
    };
    const setStatus = (txt, ok=true) => {
      const el = document.getElementById('status');
      el.textContent = txt;
      el.style.background = ok ? 'rgba(50,255,140,0.08)' : 'rgba(255,64,64,0.15)';
    };

    function hydrate(st) {
      document.getElementById('persona').value = st.persona_prompt || '';
      document.getElementById('route_default').value = st.route_default || 'both';
      document.getElementById('throttle_seconds').value = st.throttle_seconds ?? 0;
      document.getElementById('feed_enabled').checked = !!st.feed_enabled;
      document.getElementById('notifications_enabled').checked = !!st.notifications_enabled;
      document.getElementById('notify_service').value = st.notify_service || '';
      document.getElementById('notify_title').value = st.notify_title || '';
      document.getElementById('notify_tag').value = st.notify_tag || '';
      document.getElementById('quiet_start').value = st.quiet_hours_start || '22:00';
      document.getElementById('quiet_end').value = st.quiet_hours_end || '07:00';
      document.getElementById('weather_gap').value = st.weather_min_gap ?? 0;
      document.getElementById('weather_delta').value = st.weather_temp_delta ?? 5;
      document.getElementById('weather_condition').checked = st.weather_condition_change ?? true;
      document.getElementById('weather_feed_only_minor').checked = st.weather_feed_only_minor ?? false;
      document.getElementById('calendar_lead').value = st.calendar_lead_minutes ?? 60;
      document.getElementById('calendar_poll').value = st.calendar_poll_interval ?? 300;
      document.getElementById('calendar_morning_enabled').checked = st.calendar_morning_enabled ?? true;
      document.getElementById('calendar_morning_time').value = st.calendar_morning_time || '07:30';
      document.getElementById('calendar_evening_enabled').checked = st.calendar_evening_enabled ?? false;
      document.getElementById('calendar_evening_time').value = st.calendar_evening_time || '21:00';
      const cats = st.categories || {};
      document.getElementById('cat_weather').checked = cats.weather ?? true;
      document.getElementById('cat_calendar').checked = cats.calendar ?? true;
      document.getElementById('cat_system').checked = cats.system ?? true;
      document.getElementById('cat_vacuum').checked = cats.vacuum ?? true;
      document.getElementById('cat_lighting').checked = cats.lighting ?? true;
      document.getElementById('cat_arrivals').checked = cats.arrivals ?? true;
      document.getElementById('cat_people').checked = cats.people ?? true;
      document.getElementById('cat_musings').checked = cats.musings ?? true;
      document.getElementById('cat_jokes').checked = cats.jokes ?? true;
      const feedCats = st.feed_categories || {};
      document.getElementById('feed_weather').checked = feedCats.weather ?? true;
      document.getElementById('feed_calendar').checked = feedCats.calendar ?? true;
      document.getElementById('feed_system').checked = feedCats.system ?? true;
      document.getElementById('feed_vacuum').checked = feedCats.vacuum ?? true;
      document.getElementById('feed_lighting').checked = feedCats.lighting ?? true;
      document.getElementById('feed_arrivals').checked = feedCats.arrivals ?? true;
      document.getElementById('feed_people').checked = feedCats.people ?? true;
      document.getElementById('feed_musings').checked = feedCats.musings ?? true;
      document.getElementById('feed_jokes').checked = feedCats.jokes ?? true;
      document.getElementById('musing_min').value = st.musings_interval_min ?? 60;
      document.getElementById('musing_max').value = st.musings_interval_max ?? 180;
      document.getElementById('musing_cap').value = st.musings_daily_cap ?? 4;
      document.getElementById('joke_min').value = st.jokes_interval_min ?? 120;
      document.getElementById('joke_max').value = st.jokes_interval_max ?? 240;
      document.getElementById('joke_cap').value = st.jokes_daily_cap ?? 3;
      document.getElementById('musing_pool').value = (st.musing_pool || []).join('\\n');
      document.getElementById('joke_pool').value = (st.joke_pool || []).join('\\n');
      document.getElementById('news_urls').value = (st.news_urls || []).join('\\n');
      document.getElementById('calendar_entities').value = (st.calendar_entities || []).join('\\n');
      document.getElementById('unread-meta').textContent = `Unread: ${st.unread_count ?? 0}`;
      const unread = st.unread_log || [];
      document.getElementById('unread-log').textContent = unread.length ? `Unread log: ${unread.join(' | ')}` : '';
      reflowGrid();
    }

    function collectState() {
      const categories = {
        weather: document.getElementById('cat_weather').checked,
        calendar: document.getElementById('cat_calendar').checked,
        system: document.getElementById('cat_system').checked,
        vacuum: document.getElementById('cat_vacuum').checked,
        lighting: document.getElementById('cat_lighting').checked,
        arrivals: document.getElementById('cat_arrivals').checked,
        people: document.getElementById('cat_people').checked,
        musings: document.getElementById('cat_musings').checked,
        jokes: document.getElementById('cat_jokes').checked
      };
      const feed_categories = {
        weather: document.getElementById('feed_weather').checked,
        calendar: document.getElementById('feed_calendar').checked,
        system: document.getElementById('feed_system').checked,
        vacuum: document.getElementById('feed_vacuum').checked,
        lighting: document.getElementById('feed_lighting').checked,
        arrivals: document.getElementById('feed_arrivals').checked,
        people: document.getElementById('feed_people').checked,
        musings: document.getElementById('feed_musings').checked,
        jokes: document.getElementById('feed_jokes').checked
      };
      return {
        persona_prompt: document.getElementById('persona').value.trim(),
        route_default: document.getElementById('route_default').value,
        throttle_seconds: Number(document.getElementById('throttle_seconds').value) || 0,
        feed_enabled: document.getElementById('feed_enabled').checked,
        notifications_enabled: document.getElementById('notifications_enabled').checked,
        notify_service: document.getElementById('notify_service').value.trim(),
        notify_title: document.getElementById('notify_title').value.trim(),
        notify_tag: document.getElementById('notify_tag').value.trim(),
        quiet_hours_start: document.getElementById('quiet_start').value || '22:00',
        quiet_hours_end: document.getElementById('quiet_end').value || '07:00',
        weather_min_gap: Number(document.getElementById('weather_gap').value) || 0,
        weather_temp_delta: Number(document.getElementById('weather_delta').value) || 0,
        weather_condition_change: document.getElementById('weather_condition').checked,
        weather_feed_only_minor: document.getElementById('weather_feed_only_minor').checked,
        calendar_lead_minutes: Number(document.getElementById('calendar_lead').value) || 0,
        calendar_poll_interval: Number(document.getElementById('calendar_poll').value) || 300,
        calendar_morning_enabled: document.getElementById('calendar_morning_enabled').checked,
        calendar_morning_time: document.getElementById('calendar_morning_time').value || '07:30',
        calendar_evening_enabled: document.getElementById('calendar_evening_enabled').checked,
        calendar_evening_time: document.getElementById('calendar_evening_time').value || '21:00',
        categories,
        feed_categories,
        musing_pool: document.getElementById('musing_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        joke_pool: document.getElementById('joke_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        news_urls: document.getElementById('news_urls').value.split('\\n').map(v => v.trim()).filter(Boolean),
        calendar_entities: document.getElementById('calendar_entities').value.split('\\n').map(v => v.trim()).filter(Boolean),
        musings_interval_min: Number(document.getElementById('musing_min').value) || 0,
        musings_interval_max: Number(document.getElementById('musing_max').value) || 0,
        musings_daily_cap: Number(document.getElementById('musing_cap').value) || 0,
        jokes_interval_min: Number(document.getElementById('joke_min').value) || 0,
        jokes_interval_max: Number(document.getElementById('joke_max').value) || 0,
        jokes_daily_cap: Number(document.getElementById('joke_cap').value) || 0
      };
    }

    async function saveState() {
      try {
        const res = await api('api/state', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(collectState())
        });
        if (!res.ok) throw new Error(`Save failed: ${res.status}`);
        currentState = await res.json();
        hydrate(currentState);
        setStatus('Saved settings.');
      } catch (err) {
        console.error(err);
        setStatus('Failed to save settings.', false);
      }
    }

    async function loadState() {
      try {
        const res = await api('api/state');
        if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        currentState = await res.json();
        hydrate(currentState);
        setStatus('Ready.');
      } catch (err) {
        console.error(err);
        setStatus('Failed to load state.', false);
      }
    }

    const fmtTime = (raw) => {
      const d = new Date(raw);
      if (!isNaN(d.getTime())) {
        return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
      }
      const m = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(raw.trim());
      if (!m) return raw;
      let h = parseInt(m[1], 10);
      const min = m[2];
      const ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12 || 12;
      return `${h}:${min} ${ampm}`;
    };

    async function loadFeed() {
      try {
        const res = await api('api/feed');
        if (!res.ok) throw new Error(`Feed fetch failed: ${res.status}`);
        const data = await res.json();
        const feed = document.getElementById('feed');
        if (!data.entries || data.entries.length === 0) {
          feed.innerHTML = '<div class="note">No entries.</div>';
          return;
        }
        const entries = data.entries.slice().reverse().map(line => {
          const parts = line.split(' · ');
          if (parts.length >= 3) {
            const [ts, tag, ...rest] = parts;
            const msg = rest.join(' · ');
            const t = fmtTime(ts);
            return `<div class="entry"><span style="color:#eaeaea;margin-right:6px;">@ ${t}</span><span style="background:rgba(50,255,140,0.18);color:#f8f8f8;padding:2px 4px;border-radius:3px;font-size:0.75rem;margin-right:6px;">${tag}</span><span>${msg}</span></div>`;
          }
          return `<div class="entry">${line}</div>`;
        }).join('');
        feed.innerHTML = entries;
      } catch (err) {
        console.error(err);
        setStatus('Failed to load feed.', false);
      } finally {
        reflowGrid();
      }
    }

    async function loadHealth() {
      try {
        const res = await api('api/health');
        if (!res.ok) throw new Error(`Health fetch failed: ${res.status}`);
        const data = await res.json();
        document.getElementById('health-status').textContent = `Status: ${data.status}`;
        const last = data.last_emit || {};
        if (last.time) {
          const t = new Date(last.time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
          document.getElementById('health-last').textContent = `Last emit: ${last.category || ''}/${last.topic || ''} via ${last.route || ''} at ${t}`;
        } else {
          document.getElementById('health-last').textContent = 'Last emit: none';
        }
        const nextM = data.next_musing_time ? new Date(data.next_musing_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const nextJ = data.next_joke_time ? new Date(data.next_joke_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('health-next').textContent = `Next musings: ${nextM} | Next jokes: ${nextJ}`;
        const cal = data.last_calendar_poll ? new Date(data.last_calendar_poll * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('health-calendar').textContent = `Last calendar poll: ${cal}`;
        document.getElementById('health-error').textContent = data.last_error ? `Last error: ${data.last_error}` : '';
      } catch (err) {
        console.error(err);
        setStatus('Failed to load health.', false);
      } finally {
        reflowGrid();
      }
    }

    async function emit() {
      const payload = {
        topic: document.getElementById('emit_topic').value.trim() || 'general',
        category: document.getElementById('emit_category').value.trim() || 'system',
        context: document.getElementById('emit_context').value.trim() || 'All systems nominal.',
        route: document.getElementById('emit_route').value || 'default'
      };
      try {
        const res = await api('api/emit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok && res.status !== 202) throw new Error(data.detail || 'Emit failed');
        setStatus(data.status === 'throttled' ? 'Throttled.' : `Sent via ${data.route}.`);
        loadFeed();
      } catch (err) {
        console.error(err);
        setStatus('Emit failed.', false);
      }
    }

    async function markRead() {
      try {
        const res = await api('api/mark_read', { method: 'POST' });
        if (!res.ok) throw new Error(`mark_read failed: ${res.status}`);
        setStatus('Marked read.');
        loadState();
      } catch (err) {
        console.error(err);
        setStatus('Failed to mark read.', false);
      }
    }

    function toggleDetails(kind) {
      const row = document.getElementById(`row-${kind}`);
      const btn = document.getElementById(`btn-${kind}`);
      if (!row) return;
      row.style.display = row.style.display === 'none' ? '' : 'none';
      if (btn) btn.textContent = row.style.display === 'none' ? '▼' : '▲';
      requestAnimationFrame(reflowGrid);
    }

    function saveOrder() {
      if (!gridMuuri) return;
      const order = gridMuuri.getItems().map(item => {
        const el = item.getElement();
        return { id: el.dataset.id, col: el.dataset.col || "0" };
      });
      localStorage.setItem(orderKey, JSON.stringify(order));
    }

    function sortByColumn() {
      if (!gridMuuri) return;
      gridMuuri.sort((a, b) => {
        const ea = a.getElement();
        const eb = b.getElement();
        const ca = parseInt(ea.dataset.col || "0", 10);
        const cb = parseInt(eb.dataset.col || "0", 10);
        if (ca !== cb) return ca - cb;
        const ra = parseFloat(ea.dataset.row || "0");
        const rb = parseFloat(eb.dataset.row || "0");
        return ra - rb;
      }, { layout: 'instant' });
    }

    function setColumnForItem(item) {
      const gridEl = document.getElementById('card-grid');
      if (!gridEl || !item) return;
      const el = item.getElement();
      const rectGrid = gridEl.getBoundingClientRect();
      const rect = el.getBoundingClientRect();
      const relX = rect.left - rectGrid.left;
      const colWidth = rectGrid.width / 3;
      const col = Math.max(0, Math.min(2, Math.floor((relX + colWidth / 2) / colWidth)));
      el.dataset.col = String(col);
      el.dataset.row = String(item.getPosition().top || 0);
    }

    function initMuuri() {
      gridMuuri = new Muuri('#card-grid', {
        items: '.item',
        layout: { fillGaps: false, rounding: false },
        dragEnabled: true,
        dragHandle: '.card-header',
        layoutOnResize: true,
        layoutOnItemsResize: true,
        layoutOnInit: false,
        dragPlaceholder: {
          enabled: true,
          duration: 200,
          createElement: (item) => {
            const el = item.getElement().cloneNode(true);
            el.classList.add('muuri-item-placeholder');
            el.style.height = `${item.getHeight()}px`;
            el.style.width = `${item.getWidth()}px`;
            return el;
          },
        },
        dragSortPredicate: { threshold: 50, action: 'move' },
        dragSort: () => gridMuuri ? [gridMuuri] : [],
      });
      gridMuuri.getItems().forEach((it, idx) => {
        const el = it.getElement();
        if (!el.dataset.col) el.dataset.col = String(idx % 3);
        el.dataset.row = String(it.getPosition().top || 0);
      });
      gridMuuri.refreshItems();
      sortByColumn();
      const raw = localStorage.getItem(orderKey);
      if (raw) {
        try {
          const order = JSON.parse(raw);
          if (Array.isArray(order)) {
            const current = gridMuuri.getItems();
            const map = Object.fromEntries(current.map(i => [i.getElement().dataset.id, i]));
            const newOrder = [];
            order.forEach(entry => {
              if (typeof entry === 'string') {
                const it = map[entry];
                if (it) newOrder.push(it);
              } else if (entry && entry.id) {
                const it = map[entry.id];
                if (it) {
                  it.getElement().dataset.col = entry.col ?? it.getElement().dataset.col ?? "0";
                  newOrder.push(it);
                }
              }
            });
            if (newOrder.length) gridMuuri.sort(newOrder, { layout: 'instant' });
          }
        } catch (e) {
          console.error('Failed to load card order', e);
        }
      }
      gridMuuri.refreshItems();
      sortByColumn();
      gridMuuri.on('moveEnd', () => { saveOrder(); sortByColumn(); });
      gridMuuri.on('dragReleaseEnd', (item) => {
        setColumnForItem(item.getGrid().getItems().find(i => i._id === item._id) || item);
        requestAnimationFrame(() => { sortByColumn(); reflowGrid(); saveOrder(); });
      });
    }

    let autoFeed = false;
    let feedInterval = null;
    function toggleAutoFeed() {
      autoFeed = !autoFeed;
      const btn = document.getElementById('auto-btn');
      if (autoFeed) {
        loadFeed();
        feedInterval = setInterval(loadFeed, 15000);
        btn.textContent = 'Auto-refresh (on)';
      } else {
        if (feedInterval) clearInterval(feedInterval);
        btn.textContent = 'Auto-refresh';
      }
    }

    initMuuri();
    window.addEventListener('resize', () => requestAnimationFrame(() => { reflowGrid(); sortByColumn(); }));
    loadState().then(() => { loadFeed(); loadHealth(); });
  </script>
</body>
</html>
