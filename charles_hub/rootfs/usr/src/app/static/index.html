<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHARLES Hub</title>
  <style>
    :root {
      --bg: #030c0a;
      --panel: #0d1512;
      --border: #1f312c;
      --text: #d8f5e5;
      --muted: #8aa59b;
      --accent: #32ff8c;
      --shadow: 0 0 18px rgba(50, 255, 140, 0.12);
      --gap: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px 10px 24px;
      background: radial-gradient(circle at 20% 20%, #0b1612, #040805 65%);
      color: var(--text);
      font-family: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      line-height: 1.5;
    }
    h1 {
      margin: 0 0 14px;
      font-size: 1.3rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      text-shadow: 0 0 12px rgba(50, 255, 140, 0.45);
    }
    .grid {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--gap);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: var(--gap);
      align-items: start;
    }
    .item { width: 100%; }
    .item-content { width: 100%; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 14px 16px;
      box-shadow: var(--shadow);
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      color: var(--accent);
      text-transform: uppercase;
    }
    .card h3.inline {
      margin: 4px 0;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 400;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      gap: 8px;
    }
    .card-body {
      margin-top: 2px;
    }
    label {
      display: block;
      font-size: 0.86rem;
      color: var(--muted);
      margin: 8px 0 4px;
    }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      background: #0b1311;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
    }
    textarea { min-height: 140px; resize: vertical; }
    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }
    button {
      background: var(--accent);
      color: #03120b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(38, 195, 106, 0.25);
      transition: transform 0.08s ease, box-shadow 0.15s ease;
    }
    button.secondary {
      background: #0f1c16;
      color: var(--text);
      box-shadow: none;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .note { font-size: 0.82rem; color: var(--muted); margin-top: 6px; }
    .feed {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: #0a120f;
      font-size: 0.9rem;
    }
    .feed .entry { margin: 0 0 8px; }
    .feed .entry:last-child { margin-bottom: 0; }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(50,255,140,0.08);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.9rem;
    }
    .version {
      position: absolute;
      top: 12px;
      right: 12px;
      color: var(--muted);
      font-size: 0.8rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      font-size: 0.88rem;
      color: var(--text);
    }
    th {
      text-align: left;
      color: var(--accent);
      letter-spacing: 0.04em;
    }
    td.checkbox-cell {
      text-align: center;
      width: 70px;
    }
    td.checkbox-cell input {
      transform: scale(1.1);
    }
    .table-wrap {
      background: #0b1311;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 6px 4px;
      margin-top: 6px;
    }
    .ghost-btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 6px;
      margin-right: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      line-height: 1;
    }
    .cat-label { vertical-align: middle; }
    .cat-offset { margin-left: 26px; display: inline-block; }
    .detail-row .detail-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      width: 100%;
    }
    .muted-btn {
      background: #402020;
      border-color: #a55;
      color: #f8d7da;
    }
  </style>
</head>
<body>
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h1 style="margin:0;">CHARLES Hub</h1>
    <div style="display:flex; align-items:center; gap:8px;">
      <div class="version" id="ui-version">v0</div>
      <div class="status" id="status" style="display:none;"></div>
    </div>
  </div>
  <div class="note" style="margin-bottom:8px;">Tip: fill persona + notify service, set weather/calendars, then save. Use Preview to test a response without emitting.</div>
  <div class="grid" id="card-grid">
    <div class="item" data-id="persona">
      <div class="item-content">
      <div class="card" data-card="persona">
        <div class="card-header">
          <h2>Persona</h2>
        </div>
        <div class="card-body" id="body-persona">
          <label for="persona">Prompt</label>
          <textarea id="persona"></textarea>
          <h3 style="margin-top:12px; color: var(--accent); letter-spacing:0.04em; text-transform: uppercase; font-size:0.9rem;">Prompt Pools</h3>
          <label for="news_urls">News URLs (one per line)</label>
          <textarea id="news_urls"></textarea>
          <button onclick="saveState()">Save persona</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="routing">
      <div class="item-content">
      <div class="card" data-card="routing">
        <div class="card-header">
          <h2>Routing & Notify</h2>
        </div>
        <div class="card-body" id="body-routing">
      <label for="route_default">Default route</label>
      <select id="route_default" title="Where to send emits by default when route=default">
        <option value="both">both</option>
        <option value="feed">feed</option>
        <option value="notify">notify</option>
        <option value="none">none</option>
      </select>
      <label for="throttle_seconds">Throttle seconds</label>
      <input type="number" id="throttle_seconds" min="0" step="10" title="Minimum seconds between identical emits">
      <div class="toggle"><input type="checkbox" id="feed_enabled"><label for="feed_enabled">Feed enabled</label></div>
      <div class="toggle"><input type="checkbox" id="notifications_enabled"><label for="notifications_enabled">Notifications enabled</label></div>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
        <div><label for="recent_limit">Recent memory limit</label><input type="number" id="recent_limit" min="3" step="1" title="How many recent seeds/outputs to track for de-duplication"></div>
        <div><label for="notify_cap_chars">Notify summary cap (chars)</label><input type="number" id="notify_cap_chars" min="60" step="10" title="Maximum length of aggregated notification message"></div>
      </div>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
        <div><label for="notify_cap_weather">Notify cap: weather</label><input type="number" id="notify_cap_weather" min="60" step="10" placeholder="default" title="Override notify cap for weather"></div>
        <div><label for="notify_cap_presence">Notify cap: presence</label><input type="number" id="notify_cap_presence" min="60" step="10" placeholder="default" title="Override notify cap for presence/arrivals"></div>
        <div><label for="notify_cap_calendar">Notify cap: calendar</label><input type="number" id="notify_cap_calendar" min="60" step="10" placeholder="default" title="Override notify cap for calendar"></div>
      </div>
      <label for="notify_service">Notify service</label>
      <input type="text" id="notify_service" placeholder="notify.mobile_app_pixel_9" title="HA notify service for pushes">
      <label for="notify_title">Notify title</label>
      <input type="text" id="notify_title" placeholder="CHARLES says" title="Notification title">
      <label for="notify_tag">Notify tag</label>
      <input type="text" id="notify_tag" placeholder="charles_stream" title="Notification tag/group">
      <label for="conversation_agent">Conversation agent ID</label>
      <input type="text" id="conversation_agent" placeholder="conversation.openai_conversation" title="HA conversation agent entity_id">
      <h3 style="margin-top:12px; color: var(--accent); letter-spacing:0.04em; text-transform: uppercase; font-size:0.9rem;">Quiet Hours</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
        <div><label for="quiet_start">Start</label><input type="time" id="quiet_start" value="22:00"></div>
        <div><label for="quiet_end">End</label><input type="time" id="quiet_end" value="07:00"></div>
      </div>
      <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="quiet_feed_suppress"><label for="quiet_feed_suppress">Suppress feed during quiet hours</label></div>
      <div class="note" id="quiet-note"></div>
      <div class="toggle" style="margin-top:6px; gap:10px;">
        <button class="secondary" id="pause-all" onclick="toggleGlobalPause()">Pause all</button>
        <span class="note" id="pause-all-note"></span>
      </div>
      <button onclick="saveState()">Save routing</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="domains">
      <div class="item-content">
      <div class="card" data-card="domains">
        <div class="card-header">
          <h2>Domains</h2>
        </div>
        <div class="card-body" id="body-domains">
      <!-- Hidden legacy arrivals toggles to keep state compatibility -->
      <input type="checkbox" id="cat_arrivals" style="display:none;" checked>
      <input type="checkbox" id="feed_arrivals" style="display:none;" checked>
      <label style="margin-bottom:4px;">Categories</label>
      <div class="table-wrap">
      <table>
        <thead>
          <tr><th style="padding-left:12px;">Category</th><th class="checkbox-cell">Notify</th><th class="checkbox-cell">Feed</th><th class="checkbox-cell">Run</th><th class="checkbox-cell">Pause</th></tr>
        </thead>
        <tbody>
          <tr><td><button class="ghost-btn" id="btn-weather" onclick="toggleDetails('weather')">▾</button><span class="cat-label">Weather</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_weather"></td><td class="checkbox-cell"><input type="checkbox" id="feed_weather"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('weather')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-weather" onclick="pauseCategory('weather',60)">Pause</button></td></tr>
          <tr id="row-weather" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="weather_gap">Min gap (sec)</label><input type="number" id="weather_gap" min="0" step="60"></div>
                <div><label for="weather_delta">Temp delta (°)</label><input type="number" id="weather_delta" min="0" step="1"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="weather_condition"><label for="weather_condition">Only on condition change</label></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="weather_feed_only_minor"><label for="weather_feed_only_minor">Minor changes: feed only</label></div>
                <div><label for="weather_entity">Weather entity <span class="note-inline">(used for polling)</span></label><input type="text" id="weather_entity" placeholder="weather.home" title="Entity ID to poll for weather"></div>
                <div><label for="weather_poll">Poll every (sec)</label><input type="number" id="weather_poll" min="60" step="30"></div>
                <div>
                  <label for="weather_poll_route">Poll route</label>
                  <select id="weather_poll_route">
                    <option value="feed">feed</option>
                    <option value="notify">notify</option>
                    <option value="both">both</option>
                  </select>
                  <div class="note">Minor changes still respect “feed only” when enabled.</div>
                </div>
                <div><label>Available weather entities</label><select id="weather_entity_select"></select><button class="secondary" onclick="loadEntities('weather')">Refresh</button><div class="note" id="weather-entity-status"></div></div>
              </div>
            </td>
          </tr>
          <tr><td><button class="ghost-btn" id="btn-calendar" onclick="toggleDetails('calendar')">▾</button><span class="cat-label">Calendar</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_calendar"></td><td class="checkbox-cell"><input type="checkbox" id="feed_calendar"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('calendar')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-calendar" onclick="pauseCategory('calendar',60)">Pause</button></td></tr>
          <tr id="row-calendar" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                <div><label for="calendar_lead">Lead time (min)</label><input type="number" id="calendar_lead" min="0" step="5"></div>
                <div><label for="calendar_poll">Poll every (sec)</label><input type="number" id="calendar_poll" min="60" step="30"></div>
              </div>
              <label for="calendar_entities" style="margin-top:8px;">Calendars (entity ids, one per line)</label>
              <textarea id="calendar_entities" placeholder="calendar.family&#10;calendar.work"></textarea>
              <div style="margin-top:6px;">
                <label>Available calendar entities</label>
                <select id="calendar_entity_select" multiple style="min-height:80px;"></select>
                <button class="secondary" onclick="loadEntities('calendar')">Refresh</button>
                <div class="note" id="calendar-entity-status">Requires Supervisor token to list entities.</div>
              </div>
            </td>
          </tr>
          <tr><td><button class="ghost-btn" id="btn-trivia" onclick="toggleDetails('trivia')">▾</button><span class="cat-label">Trivia</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_trivia"></td><td class="checkbox-cell"><input type="checkbox" id="feed_trivia"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('trivia')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-trivia" onclick="pauseCategory('trivia',60)">Pause</button></td></tr>
          <tr id="row-trivia" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="trivia_min">Min (min)</label><input type="number" id="trivia_min" min="1" step="5"></div>
                <div><label for="trivia_max">Max (min)</label><input type="number" id="trivia_max" min="1" step="5"></div>
                <div><label for="trivia_cap">Daily cap</label><input type="number" id="trivia_cap" min="0" step="1"></div>
              </div>
              <label for="trivia_pool" style="margin-top:8px;">Trivia prompts (one per line)</label>
              <textarea id="trivia_pool" placeholder="One fact or seed per line"></textarea>
              <label for="trivia_urls" style="margin-top:8px;">Trivia text URLs (one per line)</label>
              <textarea id="trivia_urls" placeholder="https://example.com/trivia.txt"></textarea>
              <div class="note" id="trivia-meta">Fallback: /config/charles_trivia.txt (or built-in) if no prompts/URLs.</div>
              <button class="secondary" onclick="reloadTrivia()">Reload trivia</button>
            </td>
          </tr>
          <tr><td><button class="ghost-btn" id="btn-brief" onclick="toggleDetails('brief')">▾</button><span class="cat-label">Brief</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_brief"></td><td class="checkbox-cell"><input type="checkbox" id="feed_brief"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('brief')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-brief" onclick="pauseCategory('brief',60)">Pause</button></td></tr>
          <tr id="row-brief" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="brief_morning_enabled"><label for="brief_morning_enabled">Morning brief</label></div>
                <div><label for="brief_morning_time">Morning time</label><input type="time" id="brief_morning_time" value="07:45"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="brief_evening_enabled"><label for="brief_evening_enabled">Evening brief</label></div>
                <div><label for="brief_evening_time">Evening time</label><input type="time" id="brief_evening_time" value="21:15"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="brief_include_weather"><label for="brief_include_weather">Include weather</label></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="brief_include_calendar"><label for="brief_include_calendar">Include calendar</label></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="brief_include_unread"><label for="brief_include_unread">Include unread count</label></div>
                <div>
                  <label for="brief_seed_source">Seed source</label>
                  <select id="brief_seed_source">
                    <option value="musing">Musing pool</option>
                    <option value="trivia">Trivia pool</option>
                    <option value="both">Either</option>
                  </select>
                </div>
                <div style="display:flex; align-items:flex-end; gap:8px;">
                  <button class="secondary" onclick="previewBrief()">Preview brief</button>
                  <div class="note" id="brief-preview-note"></div>
                </div>
              </div>
              <div class="note">Briefs can include weather, calendar highlights, unread count, and one seed (musing/trivia).</div>
            </td>
          </tr>
          <tr><td><span class="cat-label cat-offset">System</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_system"></td><td class="checkbox-cell"><input type="checkbox" id="feed_system"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('system')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-system" onclick="pauseCategory('system',60)">Pause</button></td></tr>
          <tr><td><span class="cat-label cat-offset">Vacuum</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_vacuum"></td><td class="checkbox-cell"><input type="checkbox" id="feed_vacuum"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('vacuum')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-vacuum" onclick="pauseCategory('vacuum',60)">Pause</button></td></tr>
          <tr><td><span class="cat-label cat-offset">Lighting</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_lighting"></td><td class="checkbox-cell"><input type="checkbox" id="feed_lighting"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('lighting')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-lighting" onclick="pauseCategory('lighting',60)">Pause</button></td></tr>
          <tr><td><button class="ghost-btn" id="btn-people" onclick="toggleDetails('people')">▾</button><span class="cat-label">People</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_people"></td><td class="checkbox-cell"><input type="checkbox" id="feed_people"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('people')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-people" onclick="pauseCategory('people',60)">Pause</button></td></tr>
          <tr id="row-people" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="people_min">Snapshot min (min)</label><input type="number" id="people_min" min="1" step="5"></div>
                <div><label for="people_max">Snapshot max (min)</label><input type="number" id="people_max" min="1" step="5"></div>
                <div><label for="people_cap">Daily cap</label><input type="number" id="people_cap" min="0" step="1"></div>
                <div><label for="presence_poll">Arrival poll (sec)</label><input type="number" id="presence_poll" min="20" step="10"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="presence_auto"><label for="presence_auto">Auto-detect arrivals</label></div>
                <div><label for="arrival_delay">Arrival delay (sec)</label><input type="number" id="arrival_delay" min="0" step="5"></div>
                <div><label for="arrival_combine">Combine window (sec)</label><input type="number" id="arrival_combine" min="0" step="5"></div>
              </div>
              <div style="margin-top:6px;">
                <label>People to include</label>
                <div id="people-list" class="note">Loading people…</div>
                <div class="note" id="people-entity-status"></div>
              </div>
              <div style="margin-top:8px;">
                <label>Zones to watch</label>
                <div id="zone-list" class="note">Loading zones…</div>
                <div class="note" id="zone-entity-status"></div>
              </div>
              <div class="note">Presence updates summarize home/away; arrivals are auto-detected into selected zones/home using combine/delay.</div>
            </td>
          </tr>
          <tr>
            <td><button class="ghost-btn" id="btn-musings" onclick="toggleDetails('musings')">▾</button><span class="cat-label">Musings</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_musings"></td><td class="checkbox-cell"><input type="checkbox" id="feed_musings"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('musings')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-musings" onclick="pauseCategory('musings',60)">Pause</button></td>
          </tr>
          <tr id="row-musings" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="musing_min">Min (min)</label><input type="number" id="musing_min" min="1" step="5"></div>
                <div><label for="musing_max">Max (min)</label><input type="number" id="musing_max" min="1" step="5"></div>
                <div><label for="musing_cap">Daily cap</label><input type="number" id="musing_cap" min="0" step="1"></div>
              </div>
              <label for="musing_pool" style="margin-top:8px;">Musings (one per line)</label>
              <textarea id="musing_pool"></textarea>
            </td>
          </tr>
          <tr>
            <td><button class="ghost-btn" id="btn-jokes" onclick="toggleDetails('jokes')">▾</button><span class="cat-label">Jokes</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_jokes"></td><td class="checkbox-cell"><input type="checkbox" id="feed_jokes"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('jokes')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-jokes" onclick="pauseCategory('jokes',60)">Pause</button></td>
          </tr>
          <tr id="row-jokes" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="joke_min">Min (min)</label><input type="number" id="joke_min" min="1" step="5"></div>
                <div><label for="joke_max">Max (min)</label><input type="number" id="joke_max" min="1" step="5"></div>
                <div><label for="joke_cap">Daily cap</label><input type="number" id="joke_cap" min="0" step="1"></div>
              </div>
              <label for="joke_pool" style="margin-top:8px;">Jokes (one per line)</label>
              <textarea id="joke_pool"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
      </div>
      <button style="margin-top:10px;" onclick="saveState()">Save domains</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="emit">
      <div class="item-content">
      <div class="card" data-card="emit">
        <div class="card-header">
          <h2>Emit Test</h2>
        </div>
        <div class="card-body" id="body-emit">
      <label for="emit_topic">Topic</label>
      <input type="text" id="emit_topic" value="general">
      <label for="emit_category">Category</label>
      <input type="text" id="emit_category" value="system">
      <label for="emit_context">Context</label>
      <textarea id="emit_context">All systems nominal.</textarea>
      <label for="emit_route">Route</label>
      <select id="emit_route">
        <option value="default">default</option>
        <option value="both">both</option>
        <option value="feed">feed</option>
        <option value="notify">notify</option>
        <option value="none">none</option>
      </select>
      <div class="toggle"><input type="checkbox" id="emit_force"><label for="emit_force">Force (ignore throttles/mute)</label></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button onclick="emit()">Send emit</button>
        <button class="secondary" onclick="preview()">Preview</button>
      </div>
      <div class="note" id="preview-output"></div>
        </div>
      </div>
    </div>
    </div>
    <div class="item" data-id="feed">
      <div class="item-content">
      <div class="card" data-card="feed">
        <div class="card-header">
          <h2>Feed</h2>
        </div>
        <div class="card-body" id="body-feed">
      <div class="note" id="feed-meta">Loading feed…</div>
      <div class="feed" id="feed"></div>
      <div class="note" id="unread-meta">Unread: 0</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary" onclick="markRead()">Mark read</button>
      </div>
      <div class="note" id="unread-log"></div>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="health">
      <div class="item-content">
      <div class="card" data-card="health">
        <div class="card-header">
          <h2>Health</h2>
        </div>
        <div class="card-body" id="body-health">
          <div class="note" id="health-status">Loading…</div>
          <div class="note" id="health-last"></div>
          <div class="note" id="health-next"></div>
          <div class="note" id="health-calendar"></div>
          <div class="note" id="health-weather"></div>
          <div class="note" id="health-weather-detail"></div>
          <div class="note" id="health-error"></div>
          <button class="secondary" onclick="loadHealth()">Refresh health</button>
        </div>
      </div>
      </div>
    </div>
  </div>
  <div class="status" id="status" style="display:none;"></div>

  <script>
    let currentState = {};
    const api = (path, opts={}) => {
      const url = path.startsWith('/') ? '.' + path : path;
      return fetch(url, opts);
    };
    const reflowGrid = () => {};
    let statusTimer = null;
    const setStatus = (txt, ok=true) => {
      const el = document.getElementById('status');
      if (!el) return;
      el.textContent = txt;
      el.style.display = txt ? 'inline-block' : 'none';
      el.style.background = ok ? 'rgba(50,255,140,0.08)' : 'rgba(255,64,64,0.15)';
      el.style.border = ok ? '1px solid var(--border)' : '1px solid #b44';
      if (statusTimer) clearTimeout(statusTimer);
      if (txt) {
        statusTimer = setTimeout(() => {
          el.style.display = 'none';
        }, 10000);
      }
    };

    function hydrate(st) {
      try {
        const ver = st.addon_version || '';
        const vEl = document.getElementById('ui-version');
        if (vEl) vEl.textContent = ver ? `v${ver}` : '';
        (document.getElementById('persona') || {}).value = st.persona_prompt || '';
        (document.getElementById('route_default') || {}).value = st.route_default || 'both';
        const ts = document.getElementById('throttle_seconds'); if (ts) ts.value = st.throttle_seconds ?? 0;
        const fe = document.getElementById('feed_enabled'); if (fe) fe.checked = !!st.feed_enabled;
        const ne = document.getElementById('notifications_enabled'); if (ne) ne.checked = !!st.notifications_enabled;
        const ns = document.getElementById('notify_service'); if (ns) ns.value = st.notify_service || '';
        const nt = document.getElementById('notify_title'); if (nt) nt.value = st.notify_title || '';
        const ng = document.getElementById('notify_tag'); if (ng) ng.value = st.notify_tag || '';
        const rl = document.getElementById('recent_limit'); if (rl) rl.value = st.recent_limit ?? 10;
        const nc = document.getElementById('notify_cap_chars'); if (nc) nc.value = st.notify_cap_chars ?? 240;
        const caps = st.notify_caps || {};
        const ncw = document.getElementById('notify_cap_weather'); if (ncw) ncw.value = caps.weather ?? '';
        const ncp = document.getElementById('notify_cap_presence'); if (ncp) ncp.value = caps.people ?? caps.arrivals ?? '';
        const ncc = document.getElementById('notify_cap_calendar'); if (ncc) ncc.value = caps.calendar ?? '';
        const ca = document.getElementById('conversation_agent'); if (ca) ca.value = st.conversation_agent_id || 'conversation.openai_conversation';
        const qs = document.getElementById('quiet_start'); if (qs) qs.value = st.quiet_hours_start || '22:00';
        const qe = document.getElementById('quiet_end'); if (qe) qe.value = st.quiet_hours_end || '07:00';
        const qf = document.getElementById('quiet_feed_suppress'); if (qf) qf.checked = st.quiet_feed_suppress ?? false;
        updateQuietNote();
        updateGlobalPauseButton(st.paused_all_until || 0);
        const wg = document.getElementById('weather_gap'); if (wg) wg.value = st.weather_min_gap ?? 0;
        const wd = document.getElementById('weather_delta'); if (wd) wd.value = st.weather_temp_delta ?? 5;
        const wc = document.getElementById('weather_condition'); if (wc) wc.checked = st.weather_condition_change ?? true;
        const wf = document.getElementById('weather_feed_only_minor'); if (wf) wf.checked = st.weather_feed_only_minor ?? false;
        const wEnt = document.getElementById('weather_entity'); if (wEnt) wEnt.value = st.weather_entity || 'weather.home';
        const wSel = document.getElementById('weather_entity_select'); if (wSel) wSel.value = st.weather_entity || 'weather.home';
        const wp = document.getElementById('weather_poll'); if (wp) wp.value = st.weather_poll_interval ?? 300;
        const wr = document.getElementById('weather_poll_route'); if (wr) wr.value = st.weather_poll_route || 'feed';
        const cl = document.getElementById('calendar_lead'); if (cl) cl.value = st.calendar_lead_minutes ?? 60;
        const cp = document.getElementById('calendar_poll'); if (cp) cp.value = st.calendar_poll_interval ?? 300;
        const cats = st.categories || {};
        const feedCats = st.feed_categories || {};
        ['weather','trivia','calendar','system','vacuum','lighting','arrivals','people','musings','jokes','brief'].forEach(cat => {
          const cEl = document.getElementById(`cat_${cat}`); if (cEl) cEl.checked = cats[cat] ?? true;
          const fEl = document.getElementById(`feed_${cat}`); if (fEl) fEl.checked = feedCats[cat] ?? true;
        });
        const bm = document.getElementById('brief_morning_enabled'); if (bm) bm.checked = st.brief_enabled_morning ?? true;
        const bt = document.getElementById('brief_morning_time'); if (bt) bt.value = st.brief_time_morning || '07:45';
        const be = document.getElementById('brief_evening_enabled'); if (be) be.checked = st.brief_enabled_evening ?? false;
        const bet = document.getElementById('brief_evening_time'); if (bet) bet.value = st.brief_time_evening || '21:15';
        const biw = document.getElementById('brief_include_weather'); if (biw) biw.checked = st.brief_include_weather ?? true;
        const bic = document.getElementById('brief_include_calendar'); if (bic) bic.checked = st.brief_include_calendar ?? true;
        const biu = document.getElementById('brief_include_unread'); if (biu) biu.checked = st.brief_include_unread ?? true;
        const bss = document.getElementById('brief_seed_source'); if (bss) bss.value = st.brief_seed_source || 'musing';
        (document.getElementById('musing_min') || {}).value = st.musings_interval_min ?? 60;
        (document.getElementById('musing_max') || {}).value = st.musings_interval_max ?? 180;
        (document.getElementById('musing_cap') || {}).value = st.musings_daily_cap ?? 4;
        (document.getElementById('joke_min') || {}).value = st.jokes_interval_min ?? 120;
        (document.getElementById('joke_max') || {}).value = st.jokes_interval_max ?? 240;
        (document.getElementById('joke_cap') || {}).value = st.jokes_daily_cap ?? 3;
        (document.getElementById('musing_pool') || {}).value = (st.musing_pool || []).join('\\n');
        (document.getElementById('joke_pool') || {}).value = (st.joke_pool || []).join('\\n');
        (document.getElementById('news_urls') || {}).value = (st.news_urls || []).join('\\n');
        (document.getElementById('trivia_min') || {}).value = st.trivia_interval_min ?? 180;
        (document.getElementById('trivia_max') || {}).value = st.trivia_interval_max ?? 360;
        (document.getElementById('trivia_cap') || {}).value = st.trivia_daily_cap ?? 3;
        const tp = document.getElementById('trivia_pool'); if (tp) tp.value = (st.trivia_pool || []).join('\\n');
        const tu = document.getElementById('trivia_urls'); if (tu) tu.value = (st.trivia_urls || []).join('\\n');
        const calTxt = document.getElementById('calendar_entities'); if (calTxt) calTxt.value = (st.calendar_entities || []).join('\\n');
        const calSel = document.getElementById('calendar_entity_select');
        if (calSel) {
          const selected = (st.calendar_entities || []);
          Array.from(calSel.options).forEach((opt) => { opt.selected = selected.includes(opt.value); });
          calSel.onchange = syncCalendarSelection;
        }
        loadPeopleEntities(st.people_entities || []);
        loadZoneEntities(st.presence_zones || []);
        (document.getElementById('people_min') || {}).value = st.people_interval_min ?? 120;
        (document.getElementById('people_max') || {}).value = st.people_interval_max ?? 360;
        (document.getElementById('people_cap') || {}).value = st.people_daily_cap ?? 4;
        const pp = document.getElementById('presence_poll'); if (pp) pp.value = st.presence_poll_interval ?? 60;
        const pa = document.getElementById('presence_auto'); if (pa) pa.checked = st.presence_auto_arrivals ?? true;
        const ad = document.getElementById('arrival_delay'); if (ad) ad.value = st.arrival_emit_delay ?? 0;
        const ac = document.getElementById('arrival_combine'); if (ac) ac.value = st.arrival_combine_window ?? 300;
        const um = document.getElementById('unread-meta'); if (um) um.textContent = `Unread: ${st.unread_count ?? 0}`;
        const unread = st.unread_log || [];
        const ul = document.getElementById('unread-log'); if (ul) ul.textContent = unread.length ? `Unread log: ${unread.join(' | ')}` : '';
        const pauses = st.pauses || {};
        ['weather','calendar','trivia','brief','system','vacuum','lighting','arrivals','people','musings','jokes'].forEach(cat => updatePauseButton(cat, pauses));
      } catch (err) {
        console.error('hydrate error', err);
        setStatus('Failed to load state.', false);
      }
      reflowGrid();
    }

    function collectState() {
      const checkedOr = (id, fallback=true) => {
        const el = document.getElementById(id);
        if (el && typeof el.checked === 'boolean') return el.checked;
        return fallback;
      };
      const categories = {
        weather: checkedOr('cat_weather'),
        trivia: checkedOr('cat_trivia'),
        calendar: checkedOr('cat_calendar'),
        system: checkedOr('cat_system'),
        vacuum: checkedOr('cat_vacuum'),
        lighting: checkedOr('cat_lighting'),
        arrivals: checkedOr('cat_arrivals'),
        people: checkedOr('cat_people'),
        musings: checkedOr('cat_musings'),
        jokes: checkedOr('cat_jokes'),
        brief: checkedOr('cat_brief')
      };
      const feed_categories = {
        weather: checkedOr('feed_weather'),
        trivia: checkedOr('feed_trivia'),
        calendar: checkedOr('feed_calendar'),
        system: checkedOr('feed_system'),
        vacuum: checkedOr('feed_vacuum'),
        lighting: checkedOr('feed_lighting'),
        arrivals: checkedOr('feed_arrivals'),
        people: checkedOr('feed_people'),
        musings: checkedOr('feed_musings'),
        jokes: checkedOr('feed_jokes'),
        brief: checkedOr('feed_brief')
      };
      return {
        persona_prompt: document.getElementById('persona').value.trim(),
        route_default: document.getElementById('route_default').value,
        throttle_seconds: Number(document.getElementById('throttle_seconds').value) || 0,
        feed_enabled: document.getElementById('feed_enabled').checked,
        notifications_enabled: document.getElementById('notifications_enabled').checked,
        notify_service: document.getElementById('notify_service').value.trim(),
        notify_title: document.getElementById('notify_title').value.trim(),
        notify_tag: document.getElementById('notify_tag').value.trim(),
        notify_cap_chars: Number(document.getElementById('notify_cap_chars').value) || 240,
        recent_limit: Number(document.getElementById('recent_limit').value) || 10,
        notify_caps: (() => {
          const caps = {};
          const w = parseInt(document.getElementById('notify_cap_weather').value || '', 10);
          const p = parseInt(document.getElementById('notify_cap_presence').value || '', 10);
          const c = parseInt(document.getElementById('notify_cap_calendar').value || '', 10);
          if (!isNaN(w) && w > 0) caps.weather = w;
          if (!isNaN(p) && p > 0) {
            caps.people = p;
            caps.arrivals = p;
          }
          if (!isNaN(c) && c > 0) caps.calendar = c;
          return caps;
        })(),
        conversation_agent_id: document.getElementById('conversation_agent').value.trim() || 'conversation.openai_conversation',
        quiet_hours_start: document.getElementById('quiet_start').value || '22:00',
        quiet_hours_end: document.getElementById('quiet_end').value || '07:00',
        quiet_feed_suppress: document.getElementById('quiet_feed_suppress').checked,
        weather_min_gap: Number(document.getElementById('weather_gap').value) || 0,
        weather_temp_delta: Number(document.getElementById('weather_delta').value) || 0,
        weather_condition_change: document.getElementById('weather_condition').checked,
        weather_feed_only_minor: document.getElementById('weather_feed_only_minor').checked,
        weather_entity: document.getElementById('weather_entity').value.trim() || 'weather.home',
        weather_poll_interval: Number(document.getElementById('weather_poll').value) || 300,
        weather_poll_route: document.getElementById('weather_poll_route').value || 'feed',
        trivia_interval_min: Number(document.getElementById('trivia_min').value) || 0,
        trivia_interval_max: Number(document.getElementById('trivia_max').value) || 0,
        trivia_daily_cap: Number(document.getElementById('trivia_cap').value) || 0,
        arrival_emit_delay: Number(document.getElementById('arrival_delay').value) || 0,
        arrival_combine_window: Number(document.getElementById('arrival_combine').value) || 0,
        brief_enabled_morning: document.getElementById('brief_morning_enabled').checked,
        brief_enabled_evening: document.getElementById('brief_evening_enabled').checked,
        brief_time_morning: document.getElementById('brief_morning_time').value || '07:45',
        brief_time_evening: document.getElementById('brief_evening_time').value || '21:15',
        brief_include_weather: document.getElementById('brief_include_weather').checked,
        brief_include_calendar: document.getElementById('brief_include_calendar').checked,
        brief_include_unread: document.getElementById('brief_include_unread').checked,
        brief_seed_source: document.getElementById('brief_seed_source').value || 'musing',
        calendar_lead_minutes: Number(document.getElementById('calendar_lead').value) || 0,
        calendar_poll_interval: Number(document.getElementById('calendar_poll').value) || 300,
        categories,
        feed_categories,
        musing_pool: document.getElementById('musing_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        joke_pool: document.getElementById('joke_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        trivia_pool: document.getElementById('trivia_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        trivia_urls: document.getElementById('trivia_urls').value.split('\\n').map(v => v.trim()).filter(Boolean),
        news_urls: document.getElementById('news_urls').value.split('\\n').map(v => v.trim()).filter(Boolean),
        calendar_entities: document.getElementById('calendar_entities').value.split('\\n').map(v => v.trim()).filter(Boolean),
        people_entities: Array.from(document.querySelectorAll('.person-choice:checked')).map(el => el.value || el.dataset.id).filter(Boolean),
        presence_zones: Array.from(document.querySelectorAll('.zone-choice:checked')).map(el => el.value || el.dataset.id).filter(Boolean),
        musings_interval_min: Number(document.getElementById('musing_min').value) || 0,
        musings_interval_max: Number(document.getElementById('musing_max').value) || 0,
        musings_daily_cap: Number(document.getElementById('musing_cap').value) || 0,
        jokes_interval_min: Number(document.getElementById('joke_min').value) || 0,
        jokes_interval_max: Number(document.getElementById('joke_max').value) || 0,
        jokes_daily_cap: Number(document.getElementById('joke_cap').value) || 0,
        people_interval_min: Number(document.getElementById('people_min').value) || 0,
        people_interval_max: Number(document.getElementById('people_max').value) || 0,
        people_daily_cap: Number(document.getElementById('people_cap').value) || 0,
        presence_poll_interval: Number(document.getElementById('presence_poll').value) || 60,
        presence_auto_arrivals: document.getElementById('presence_auto').checked
      };
    }

    async function saveState() {
      try {
        const res = await api('api/state', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(collectState())
        });
        if (!res.ok) throw new Error(`Save failed: ${res.status}`);
        currentState = await res.json();
        hydrate(currentState);
        setStatus('Saved settings.');
      } catch (err) {
        console.error(err);
        setStatus('Failed to save settings.', false);
      }
    }

    async function loadState() {
      try {
        const res = await api('api/state');
        if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        currentState = await res.json();
        hydrate(currentState);
        setStatus('Ready.');
      } catch (err) {
        console.error('loadState error', err);
        setStatus('Failed to load state.', false);
        currentState = currentState || {};
        hydrate(currentState);
      }
    }

    const fmtTime = (raw) => {
      const d = new Date(raw);
      if (!isNaN(d.getTime())) {
        return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
      }
      const m = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(raw.trim());
      if (!m) return raw;
      let h = parseInt(m[1], 10);
      const min = m[2];
      const ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12 || 12;
      return `${h}:${min} ${ampm}`;
    };

    async function loadFeed() {
      try {
        const res = await api('api/feed');
        if (!res.ok) throw new Error(`Feed fetch failed: ${res.status}`);
        const data = await res.json();
        const feed = document.getElementById('feed');
        if (!data.entries || data.entries.length === 0) {
          feed.innerHTML = '<div class="note">No entries.</div>';
          return;
        }
        const entries = data.entries.slice().reverse().map(line => {
          const parts = line.split(' · ');
          if (parts.length >= 3) {
            const [ts, tag, ...rest] = parts;
            const msg = rest.join(' · ');
            const t = fmtTime(ts);
            return `<div class="entry"><span style="color:#eaeaea;margin-right:6px;">@ ${t}</span><span style="background:rgba(50,255,140,0.18);color:#f8f8f8;padding:2px 4px;border-radius:3px;font-size:0.75rem;margin-right:6px;">${tag}</span><span>${msg}</span></div>`;
          }
          return `<div class="entry">${line}</div>`;
        }).join('');
        feed.innerHTML = entries;
      } catch (err) {
        console.error(err);
        setStatus('Failed to load feed.', false);
      } finally {
        reflowGrid();
      }
    }

    async function loadHealth() {
      try {
        const res = await api('api/health');
        if (!res.ok) throw new Error(`Health fetch failed: ${res.status}`);
        const data = await res.json();
        document.getElementById('health-status').textContent = `Status: ${data.status}`;
        const last = data.last_emit || {};
        if (last.time) {
          const t = new Date(last.time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
          document.getElementById('health-last').textContent = `Last emit: ${last.category || ''}/${last.topic || ''} via ${last.route || ''} at ${t}`;
        } else {
          document.getElementById('health-last').textContent = 'Last emit: none';
        }
        const nextM = data.next_musing_time ? new Date(data.next_musing_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const nextJ = data.next_joke_time ? new Date(data.next_joke_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const nextT = data.next_trivia_time ? new Date(data.next_trivia_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const nextP = data.next_people_time ? new Date(data.next_people_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('health-next').textContent = `Next musings: ${nextM} | Next jokes: ${nextJ} | Next trivia: ${nextT} | Next people: ${nextP}`;
        const qNote = document.getElementById('quiet-note');
        if (qNote) {
          const qActive = data.quiet_active;
          const qFeed = data.quiet_feed_suppress;
          qNote.textContent = qActive ? `Quiet hours active. ${qFeed ? 'Feed suppressed.' : 'Notifications only suppressed.'}` : 'Quiet hours inactive now.';
        }
        const cal = data.last_calendar_poll ? new Date(data.last_calendar_poll * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('health-calendar').textContent = `Last calendar poll: ${cal}`;
        const wTs = data.last_weather_time ? new Date(data.last_weather_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const wGap = data.weather_min_gap ?? 'n/a';
        const wDelta = data.weather_temp_delta ?? 'n/a';
        const wCond = data.weather_condition_change ? 'yes' : 'no';
        document.getElementById('health-weather').textContent = `Last weather emit: ${wTs} | Min gap: ${wGap}s | ΔT: ${wDelta} | Cond change: ${wCond}`;
        const wp = data.last_weather_payload || {};
        document.getElementById('health-weather-detail').textContent = wp.condition ? `Last weather payload: ${wp.condition} @ ${wp.temperature}` : '';
        document.getElementById('health-error').textContent = data.last_error ? `Last error: ${data.last_error}` : '';
      } catch (err) {
        console.error(err);
        setStatus('Failed to load health.', false);
      } finally {
        reflowGrid();
      }
    }

    async function emit() {
      const payload = {
        topic: document.getElementById('emit_topic').value.trim() || 'general',
        category: document.getElementById('emit_category').value.trim() || 'system',
        context: document.getElementById('emit_context').value.trim() || 'All systems nominal.',
        route: document.getElementById('emit_route').value || 'default'
      };
      if (document.getElementById('emit_force').checked) {
        payload.force = true;
      }
      try {
        const res = await api('api/emit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok && res.status !== 202) throw new Error(data.detail || 'Emit failed');
        setStatus(data.status === 'throttled' ? 'Throttled.' : `Sent via ${data.route}.`);
        loadFeed();
      } catch (err) {
        console.error(err);
        setStatus('Emit failed.', false);
      }
    }

    async function preview() {
      const payload = {
        topic: document.getElementById('emit_topic').value.trim() || 'general',
        category: document.getElementById('emit_category').value.trim() || 'system',
        context: document.getElementById('emit_context').value.trim() || 'All systems nominal.',
      };
      try {
        const res = await api('api/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Preview failed');
        document.getElementById('preview-output').textContent = data.message || '';
        setStatus('Preview ready.');
      } catch (err) {
        console.error(err);
        document.getElementById('preview-output').textContent = '';
        setStatus('Preview failed.', false);
      }
    }

    async function previewBrief() {
      try {
        setStatus('Building brief preview…');
        const res = await api('api/preview/brief');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Brief preview failed');
        const out = document.getElementById('preview-output');
        if (out) out.textContent = data.message || data.context || '';
        const note = document.getElementById('brief-preview-note');
        if (note) note.textContent = data.context ? `Context: ${data.context}` : '';
        setStatus('Brief preview ready.');
      } catch (err) {
        console.error(err);
        const note = document.getElementById('brief-preview-note');
        if (note) note.textContent = '';
        setStatus('Brief preview failed.', false);
      }
    }

    async function markRead() {
      try {
        const res = await api('api/mark_read', { method: 'POST' });
        if (!res.ok) throw new Error(`mark_read failed: ${res.status}`);
        setStatus('Marked read.');
        loadState();
      } catch (err) {
        console.error(err);
        setStatus('Failed to mark read.', false);
      }
    }

    async function quickEmit(cat) {
      try {
        const res = await api('api/trigger', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: cat, force: cat === 'weather' })
        });
        const data = await res.json();
        if (!res.ok && res.status !== 202) throw new Error(data.detail || 'Trigger failed');
        setStatus(data.status === 'throttled' ? `Throttled (${cat}).` : `Triggered ${cat}.`);
        loadFeed();
      } catch (err) {
        console.error(err);
        setStatus('Quick trigger failed.', false);
      }
    }

    async function pauseCategory(cat, minutes) {
      try {
        const now = Date.now() / 1000;
        const pauses = currentState.pauses || {};
        const alreadyPaused = pauses[cat] && pauses[cat] > now;
        const targetMinutes = alreadyPaused ? 0 : minutes;
        const res = await api('api/pause', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: cat, minutes: targetMinutes })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Pause failed');
        const until = data.paused_until ? new Date(data.paused_until * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'cleared';
        setStatus(`Pause updated for ${cat}: ${until}`);
        const newPauses = currentState.pauses || {};
        if (data.paused_until && data.paused_until > 0) {
          newPauses[cat] = data.paused_until;
        } else {
          delete newPauses[cat];
        }
        currentState.pauses = newPauses;
        updatePauseButton(cat, newPauses);
      } catch (err) {
        console.error(err);
        setStatus('Pause update failed.', false);
      }
    }

    async function reloadTrivia() {
      try {
        setStatus('Reloading trivia…');
        const res = await api('api/trivia/reload', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Trivia reload failed');
        const loadedAt = data.loaded_at ? new Date(data.loaded_at * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('trivia-meta').textContent = `Loaded ${data.count || 0} trivia items at ${loadedAt}. Fallback: /config/charles_trivia.txt (or built-in)`;
        setStatus('Trivia reloaded.');
      } catch (err) {
        console.error(err);
        setStatus('Failed to reload trivia.', false);
      }
    }

    function updatePauseButton(cat, pauses) {
      const btn = document.getElementById(`pause-${cat}`);
      if (!btn) return;
      const now = Date.now() / 1000;
      const until = (pauses && pauses[cat]) ? pauses[cat] : 0;
      const paused = until > now;
      btn.classList.toggle('muted-btn', paused);
      btn.textContent = paused ? 'Paused' : 'Pause';
      btn.title = paused ? `Paused until ${new Date(until * 1000).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' })}` : 'Pause for 60m';
    }

    function updateGlobalPauseButton(pausedUntil) {
      const btn = document.getElementById('pause-all');
      const note = document.getElementById('pause-all-note');
      if (!btn) return;
      const now = Date.now() / 1000;
      const paused = (pausedUntil || 0) > now;
      btn.classList.toggle('muted-btn', paused);
      btn.textContent = paused ? 'Resume all' : 'Pause all';
      btn.title = paused ? `Paused until ${new Date(pausedUntil * 1000).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' })}` : 'Pause all for 60m';
      if (note) note.textContent = paused ? `Paused until ${new Date(pausedUntil * 1000).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' })}` : 'Silence all categories for 60 minutes.';
      currentState.paused_all_until = pausedUntil || 0;
    }

    async function toggleGlobalPause() {
      try {
        const pausedUntil = currentState.paused_all_until || 0;
        const now = Date.now() / 1000;
        const currentlyPaused = pausedUntil > now;
        const minutes = currentlyPaused ? 0 : 60;
        const res = await api('api/pause', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: 'all', minutes })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Pause failed');
        updateGlobalPauseButton(data.paused_until || 0);
        setStatus(currentlyPaused ? 'Global pause cleared.' : 'Global pause enabled for 60m.');
      } catch (err) {
        console.error(err);
        setStatus('Global pause failed.', false);
      }
    }

    function updateQuietNote() {
      const qNote = document.getElementById('quiet-note');
      if (!qNote) return;
      const start = document.getElementById('quiet_start')?.value || '22:00';
      const end = document.getElementById('quiet_end')?.value || '07:00';
      const suppress = document.getElementById('quiet_feed_suppress')?.checked;
      qNote.textContent = `Quiet hours: ${start} – ${end}. ${suppress ? 'Feed will be suppressed during quiet hours.' : 'Notifications are suppressed; feed stays on.'}`;
    }

    function syncCalendarSelection() {
      const sel = document.getElementById('calendar_entity_select');
      const txt = document.getElementById('calendar_entities');
      if (!sel || !txt) return;
      const selected = Array.from(sel.selectedOptions || []).map((opt) => opt.value.trim()).filter(Boolean);
      txt.value = selected.join('\\n');
    }

    async function loadEntities(domain) {
      try {
        const res = await api(`api/entities/${domain}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Fetch failed');
        const sel = domain === 'weather'
          ? document.getElementById('weather_entity_select')
          : document.getElementById('calendar_entity_select');
        const statusEl = domain === 'weather'
          ? document.getElementById('weather-entity-status')
          : document.getElementById('calendar-entity-status');
        if (!sel) return;
        sel.innerHTML = '';
        (data.entities || []).forEach((item) => {
          const opt = document.createElement('option');
          opt.value = item.entity_id;
          opt.textContent = item.name ? `${item.name} (${item.entity_id})` : item.entity_id;
          sel.appendChild(opt);
        });
        if (domain === 'calendar') {
          const desired = (document.getElementById('calendar_entities')?.value || '').split('\\n').map(v => v.trim()).filter(Boolean);
          Array.from(sel.options).forEach(opt => { opt.selected = desired.includes(opt.value); });
          syncCalendarSelection();
        }
        if (domain === 'zone') {
          const selected = currentState.presence_zones || [];
          const list = document.getElementById('zone-list');
          if (list) {
            list.innerHTML = (data.entities || []).map((item) => {
              const id = item.entity_id;
              const name = item.name || id;
              const checked = selected.includes(id) ? 'checked' : '';
              return `<label style="display:flex; align-items:center; gap:8px; margin:4px 0;"><input class="zone-choice" type="checkbox" value="${id}" ${checked}>${name}</label>`;
            }).join('');
          }
        }
        if (domain === 'weather') {
          const ent = document.getElementById('weather_entity')?.value || '';
          if (ent) sel.value = ent;
        }
        if (statusEl) statusEl.textContent = `Loaded ${data.entities?.length || 0} ${domain} entities.`;
        setStatus(`Loaded ${data.entities?.length || 0} ${domain} entities.`);
      } catch (err) {
        console.error(err);
        const msg = err?.message || err?.toString() || 'Failed';
        const statusEl = domain === 'weather' ? document.getElementById('weather-entity-status') : document.getElementById('calendar-entity-status');
        if (statusEl) statusEl.textContent = `Failed to load ${domain} entities: ${msg}. Ensure SUPERVISOR_TOKEN is available.`;
        setStatus(`Failed to load ${domain} entities. ${msg}`, false);
      }
    }

    async function loadPeopleEntities(selectedIds) {
      try {
        const res = await api('api/entities/person');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Fetch failed');
        const list = document.getElementById('people-list');
        const statusEl = document.getElementById('people-entity-status');
        if (!list) return;
        const selected = selectedIds || currentState.people_entities || [];
        const items = data.entities || [];
        if (!items.length) {
          list.innerHTML = '<div class="note">No person entities found. Ensure person.* exists and SUPERVISOR_TOKEN is set.</div>';
        } else {
          list.innerHTML = items.map((item) => {
            const id = item.entity_id;
            const name = item.name || id;
            const checked = selected.includes(id) ? 'checked' : '';
            return `<label style="display:flex; align-items:center; gap:8px; margin:4px 0;"><input class="person-choice" type="checkbox" value="${id}" ${checked}>${name}</label>`;
          }).join('');
        }
        if (statusEl) statusEl.textContent = `Loaded ${items.length} people.`;
        setStatus('Loaded people.');
      } catch (err) {
        console.error(err);
        const statusEl = document.getElementById('people-entity-status');
        const msg = err?.message || err?.toString() || 'Failed';
        if (statusEl) statusEl.textContent = `Failed to load people: ${msg}. Ensure SUPERVISOR_TOKEN is available.`;
        setStatus('Failed to load people.', false);
      }
    }

    async function loadZoneEntities(selectedIds) {
      try {
        const res = await api('api/entities/zone');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Fetch failed');
        const list = document.getElementById('zone-list');
        const statusEl = document.getElementById('zone-entity-status');
        if (!list) return;
        const selected = selectedIds || currentState.presence_zones || [];
        const items = data.entities || [];
        if (!items.length) {
          list.innerHTML = '<div class="note">No zones found. Ensure zone.* exists and SUPERVISOR_TOKEN is set.</div>';
        } else {
          list.innerHTML = items.map((item) => {
            const id = item.entity_id;
            const name = item.name || id;
            const checked = selected.includes(id) ? 'checked' : '';
            return `<label style="display:flex; align-items:center; gap:8px; margin:4px 0;"><input class="zone-choice" type="checkbox" value="${id}" ${checked}>${name}</label>`;
          }).join('');
        }
        if (statusEl) statusEl.textContent = `Loaded ${items.length} zones.`;
        setStatus('Loaded zones.');
      } catch (err) {
        console.error(err);
        const statusEl = document.getElementById('zone-entity-status');
        const msg = err?.message || err?.toString() || 'Failed';
        if (statusEl) statusEl.textContent = `Failed to load zones: ${msg}. Ensure SUPERVISOR_TOKEN is available.`;
        setStatus('Failed to load zones.', false);
      }
    }

    function toggleDetails(kind) {
      const row = document.getElementById(`row-${kind}`);
      const btn = document.getElementById(`btn-${kind}`);
      if (!row) return;
      row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
      if (btn) btn.textContent = row.style.display === 'none' ? '▼' : '▲';
      requestAnimationFrame(reflowGrid);
    }

    function saveOrder() {
      return;
    }

    function initMuuri() {
      return;
    }

    let autoFeed = false;
    let feedInterval = null;
    function toggleAutoFeed() {
      autoFeed = true;
      loadFeed();
      if (feedInterval) clearInterval(feedInterval);
      feedInterval = setInterval(loadFeed, 15000);
    }

    initMuuri();
    window.addEventListener('resize', () => {});
    loadState().then(() => { loadFeed(); loadHealth(); toggleAutoFeed(); });
  </script>
</body>
</html>
