<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHARLES Hub</title>
  <style>
    :root {
      --bg: #030c0a;
      --panel: #0d1512;
      --border: #1f312c;
      --text: #d8f5e5;
      --muted: #8aa59b;
      --accent: #32ff8c;
      --shadow: 0 0 18px rgba(50, 255, 140, 0.12);
      --gap: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px 10px 24px;
      background: radial-gradient(circle at 20% 20%, #0b1612, #040805 65%);
      color: var(--text);
      font-family: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      line-height: 1.5;
    }
    h1 {
      margin: 0 0 14px;
      font-size: 1.3rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      text-shadow: 0 0 12px rgba(50, 255, 140, 0.45);
    }
    .grid {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--gap);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: var(--gap);
      align-items: start;
    }
    .item { width: 100%; }
    .item-content { width: 100%; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 14px 16px;
      box-shadow: var(--shadow);
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      color: var(--accent);
      text-transform: uppercase;
    }
    .card h3.inline {
      margin: 4px 0;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 400;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      gap: 8px;
    }
    .card-body {
      margin-top: 2px;
    }
    label {
      display: block;
      font-size: 0.86rem;
      color: var(--muted);
      margin: 8px 0 4px;
    }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      background: #0b1311;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
    }
    textarea { min-height: 140px; resize: vertical; }
    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }
    button {
      background: var(--accent);
      color: #03120b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(38, 195, 106, 0.25);
      transition: transform 0.08s ease, box-shadow 0.15s ease;
    }
    button.secondary {
      background: #0f1c16;
      color: var(--text);
      box-shadow: none;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .note { font-size: 0.82rem; color: var(--muted); margin-top: 6px; }
    .feed {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: #0a120f;
      font-size: 0.9rem;
    }
    .feed .entry { margin: 0 0 8px; }
    .feed .entry:last-child { margin-bottom: 0; }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(50,255,140,0.08);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.9rem;
    }
    .version {
      position: absolute;
      top: 12px;
      right: 12px;
      color: var(--muted);
      font-size: 0.8rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      font-size: 0.88rem;
      color: var(--text);
    }
    th {
      text-align: left;
      color: var(--accent);
      letter-spacing: 0.04em;
    }
    td.checkbox-cell {
      text-align: center;
      width: 70px;
    }
    td.checkbox-cell input {
      transform: scale(1.1);
    }
    .table-wrap {
      background: #0b1311;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 6px 4px;
      margin-top: 6px;
    }
    .ghost-btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 6px;
      margin-right: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      line-height: 1;
    }
    .cat-label { vertical-align: middle; }
    .cat-offset { margin-left: 26px; display: inline-block; }
    .detail-row .detail-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      width: 100%;
    }
    .muted-btn {
      background: #402020;
      border-color: #a55;
      color: #f8d7da;
    }
  </style>
</head>
<body>
  <h1>CHARLES Hub</h1>
  <div class="version" id="ui-version">v0</div>
  <div class="grid" id="card-grid">
    <div class="item" data-id="persona">
      <div class="item-content">
      <div class="card" data-card="persona">
        <div class="card-header">
          <h2>Persona</h2>
        </div>
        <div class="card-body" id="body-persona">
          <label for="persona">Prompt</label>
          <textarea id="persona"></textarea>
          <h3 style="margin-top:12px; color: var(--accent); letter-spacing:0.04em; text-transform: uppercase; font-size:0.9rem;">Prompt Pools</h3>
          <label for="news_urls">News URLs (one per line)</label>
          <textarea id="news_urls"></textarea>
          <button onclick="saveState()">Save persona</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="routing">
      <div class="item-content">
      <div class="card" data-card="routing">
        <div class="card-header">
          <h2>Routing & Notify</h2>
        </div>
        <div class="card-body" id="body-routing">
      <label for="route_default">Default route</label>
      <select id="route_default" title="Where to send emits by default when route=default">
        <option value="both">both</option>
        <option value="feed">feed</option>
        <option value="notify">notify</option>
        <option value="none">none</option>
      </select>
      <label for="throttle_seconds">Throttle seconds</label>
      <input type="number" id="throttle_seconds" min="0" step="10" title="Minimum seconds between identical emits">
      <div class="toggle"><input type="checkbox" id="feed_enabled"><label for="feed_enabled">Feed enabled</label></div>
      <div class="toggle"><input type="checkbox" id="notifications_enabled"><label for="notifications_enabled">Notifications enabled</label></div>
      <label for="notify_service">Notify service</label>
      <input type="text" id="notify_service" placeholder="notify.mobile_app_pixel_9" title="HA notify service for pushes">
      <label for="notify_title">Notify title</label>
      <input type="text" id="notify_title" placeholder="CHARLES says" title="Notification title">
      <label for="notify_tag">Notify tag</label>
      <input type="text" id="notify_tag" placeholder="charles_stream" title="Notification tag/group">
      <h3 style="margin-top:12px; color: var(--accent); letter-spacing:0.04em; text-transform: uppercase; font-size:0.9rem;">Quiet Hours</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
        <div><label for="quiet_start">Start</label><input type="time" id="quiet_start" value="22:00"></div>
        <div><label for="quiet_end">End</label><input type="time" id="quiet_end" value="07:00"></div>
      </div>
      <button onclick="saveState()">Save routing</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="domains">
      <div class="item-content">
      <div class="card" data-card="domains">
        <div class="card-header">
          <h2>Domains</h2>
        </div>
        <div class="card-body" id="body-domains">
      <label style="margin-bottom:4px;">Categories</label>
      <div class="table-wrap">
      <table>
        <thead>
          <tr><th style="padding-left:12px;">Category</th><th class="checkbox-cell">Notify</th><th class="checkbox-cell">Feed</th><th class="checkbox-cell">Run</th><th class="checkbox-cell">Pause</th></tr>
        </thead>
        <tbody>
          <tr><td><button class="ghost-btn" id="btn-weather" onclick="toggleDetails('weather')">▾</button><span class="cat-label">Weather</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_weather"></td><td class="checkbox-cell"><input type="checkbox" id="feed_weather"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('weather')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-weather" onclick="pauseCategory('weather',60)">Pause</button></td></tr>
          <tr id="row-weather" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="weather_gap">Min gap (sec)</label><input type="number" id="weather_gap" min="0" step="60"></div>
                <div><label for="weather_delta">Temp delta (°)</label><input type="number" id="weather_delta" min="0" step="1"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="weather_condition"><label for="weather_condition">Only on condition change</label></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="weather_feed_only_minor"><label for="weather_feed_only_minor">Minor changes: feed only</label></div>
                <div><label for="weather_entity">Weather entity <span class="note-inline">(used for polling)</span></label><input type="text" id="weather_entity" placeholder="weather.home" title="Entity ID to poll for weather"></div>
                <div><label for="weather_poll">Poll every (sec)</label><input type="number" id="weather_poll" min="60" step="30"></div>
                <div><label>Available weather entities</label><select id="weather_entity_select"></select><button class="secondary" onclick="loadEntities('weather')">Refresh</button><div class="note" id="weather-entity-status"></div></div>
              </div>
            </td>
          </tr>
          <tr><td><button class="ghost-btn" id="btn-calendar" onclick="toggleDetails('calendar')">▾</button><span class="cat-label">Calendar</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_calendar"></td><td class="checkbox-cell"><input type="checkbox" id="feed_calendar"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('calendar')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-calendar" onclick="pauseCategory('calendar',60)">Pause</button></td></tr>
          <tr id="row-calendar" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                <div><label for="calendar_lead">Lead time (min)</label><input type="number" id="calendar_lead" min="0" step="5"></div>
                <div><label for="calendar_poll">Poll every (sec)</label><input type="number" id="calendar_poll" min="60" step="30"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="calendar_morning_enabled"><label for="calendar_morning_enabled">Morning brief</label></div>
                <div><label for="calendar_morning_time">Morning time</label><input type="time" id="calendar_morning_time" value="07:30"></div>
                <div class="toggle" style="margin-top:6px;"><input type="checkbox" id="calendar_evening_enabled"><label for="calendar_evening_enabled">Evening brief</label></div>
                <div><label for="calendar_evening_time">Evening time</label><input type="time" id="calendar_evening_time" value="21:00"></div>
              </div>
              <label for="calendar_entities" style="margin-top:8px;">Calendars (entity ids, one per line)</label>
              <textarea id="calendar_entities" placeholder="calendar.family&#10;calendar.work"></textarea>
              <div style="margin-top:6px;">
                <label>Available calendar entities</label>
                <select id="calendar_entity_select" multiple style="min-height:80px;"></select>
                <button class="secondary" onclick="loadEntities('calendar')">Refresh</button>
                <div class="note" id="calendar-entity-status"></div>
              </div>
            </td>
          </tr>
          <tr><td><button class="ghost-btn" id="btn-trivia" onclick="toggleDetails('trivia')">▾</button><span class="cat-label">Trivia</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_trivia"></td><td class="checkbox-cell"><input type="checkbox" id="feed_trivia"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('trivia')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-trivia" onclick="pauseCategory('trivia',60)">Pause</button></td></tr>
          <tr id="row-trivia" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="trivia_min">Min (min)</label><input type="number" id="trivia_min" min="1" step="5"></div>
                <div><label for="trivia_max">Max (min)</label><input type="number" id="trivia_max" min="1" step="5"></div>
                <div><label for="trivia_cap">Daily cap</label><input type="number" id="trivia_cap" min="0" step="1"></div>
              </div>
              <label for="trivia_pool" style="margin-top:8px;">Trivia prompts (one per line)</label>
              <textarea id="trivia_pool" placeholder="One fact or seed per line"></textarea>
              <label for="trivia_urls" style="margin-top:8px;">Trivia text URLs (one per line)</label>
              <textarea id="trivia_urls" placeholder="https://example.com/trivia.txt"></textarea>
              <div class="note" id="trivia-meta">Fallback: /config/charles_trivia.txt (or built-in) if no prompts/URLs.</div>
              <button class="secondary" onclick="reloadTrivia()">Reload trivia</button>
            </td>
          </tr>
          <tr><td><span class="cat-label cat-offset">System</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_system"></td><td class="checkbox-cell"><input type="checkbox" id="feed_system"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('system')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-system" onclick="pauseCategory('system',60)">Pause</button></td></tr>
          <tr><td><span class="cat-label cat-offset">Vacuum</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_vacuum"></td><td class="checkbox-cell"><input type="checkbox" id="feed_vacuum"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('vacuum')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-vacuum" onclick="pauseCategory('vacuum',60)">Pause</button></td></tr>
          <tr><td><span class="cat-label cat-offset">Lighting</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_lighting"></td><td class="checkbox-cell"><input type="checkbox" id="feed_lighting"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('lighting')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-lighting" onclick="pauseCategory('lighting',60)">Pause</button></td></tr>
          <tr><td><button class="ghost-btn" id="btn-arrivals" onclick="toggleDetails('arrivals')">▾</button><span class="cat-label">Arrivals</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_arrivals"></td><td class="checkbox-cell"><input type="checkbox" id="feed_arrivals"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('arrivals')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-arrivals" onclick="pauseCategory('arrivals',60)">Pause</button></td></tr>
          <tr id="row-arrivals" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="arrival_delay">Delay emit (sec)</label><input type="number" id="arrival_delay" min="0" step="10"></div>
                <div><label for="arrival_combine">Combine window (sec)</label><input type="number" id="arrival_combine" min="0" step="10"></div>
              </div>
              <div class="note">Delay buffers arrivals to avoid drive-through noise; combine merges arrivals to same location within window.</div>
            </td>
          </tr>
          <tr><td><span class="cat-label cat-offset">People</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_people"></td><td class="checkbox-cell"><input type="checkbox" id="feed_people"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('people')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-people" onclick="pauseCategory('people',60)">Pause</button></td></tr>
          <tr>
            <td><button class="ghost-btn" id="btn-musings" onclick="toggleDetails('musings')">▾</button><span class="cat-label">Musings</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_musings"></td><td class="checkbox-cell"><input type="checkbox" id="feed_musings"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('musings')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-musings" onclick="pauseCategory('musings',60)">Pause</button></td>
          </tr>
          <tr id="row-musings" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="musing_min">Min (min)</label><input type="number" id="musing_min" min="1" step="5"></div>
                <div><label for="musing_max">Max (min)</label><input type="number" id="musing_max" min="1" step="5"></div>
                <div><label for="musing_cap">Daily cap</label><input type="number" id="musing_cap" min="0" step="1"></div>
              </div>
              <label for="musing_pool" style="margin-top:8px;">Musings (one per line)</label>
              <textarea id="musing_pool"></textarea>
            </td>
          </tr>
          <tr>
            <td><button class="ghost-btn" id="btn-jokes" onclick="toggleDetails('jokes')">▾</button><span class="cat-label">Jokes</span></td><td class="checkbox-cell"><input type="checkbox" id="cat_jokes"></td><td class="checkbox-cell"><input type="checkbox" id="feed_jokes"></td><td class="checkbox-cell"><button class="secondary" onclick="quickEmit('jokes')">▶</button></td><td class="checkbox-cell"><button class="secondary" id="pause-jokes" onclick="pauseCategory('jokes',60)">Pause</button></td>
          </tr>
          <tr id="row-jokes" class="detail-row" style="display:none;">
            <td colspan="5">
              <div class="detail-box" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:8px;">
                <div><label for="joke_min">Min (min)</label><input type="number" id="joke_min" min="1" step="5"></div>
                <div><label for="joke_max">Max (min)</label><input type="number" id="joke_max" min="1" step="5"></div>
                <div><label for="joke_cap">Daily cap</label><input type="number" id="joke_cap" min="0" step="1"></div>
              </div>
              <label for="joke_pool" style="margin-top:8px;">Jokes (one per line)</label>
              <textarea id="joke_pool"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
      </div>
      <button style="margin-top:10px;" onclick="saveState()">Save domains</button>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="emit">
      <div class="item-content">
      <div class="card" data-card="emit">
        <div class="card-header">
          <h2>Emit Test</h2>
        </div>
        <div class="card-body" id="body-emit">
      <label for="emit_topic">Topic</label>
      <input type="text" id="emit_topic" value="general">
      <label for="emit_category">Category</label>
      <input type="text" id="emit_category" value="system">
      <label for="emit_context">Context</label>
      <textarea id="emit_context">All systems nominal.</textarea>
      <label for="emit_route">Route</label>
      <select id="emit_route">
        <option value="default">default</option>
        <option value="both">both</option>
        <option value="feed">feed</option>
        <option value="notify">notify</option>
        <option value="none">none</option>
      </select>
      <div class="toggle"><input type="checkbox" id="emit_force"><label for="emit_force">Force (ignore throttles/mute)</label></div>
      <button onclick="emit()">Send emit</button>
        </div>
      </div>
    </div>
    </div>
    <div class="item" data-id="feed">
      <div class="item-content">
      <div class="card" data-card="feed">
        <div class="card-header">
          <h2>Feed</h2>
        </div>
        <div class="card-body" id="body-feed">
      <div class="note" id="feed-meta">Loading feed…</div>
      <div class="feed" id="feed"></div>
      <div class="note" id="unread-meta">Unread: 0</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary" onclick="markRead()">Mark read</button>
      </div>
      <div class="note" id="unread-log"></div>
        </div>
      </div>
      </div>
    </div>
    <div class="item" data-id="health">
      <div class="item-content">
      <div class="card" data-card="health">
        <div class="card-header">
          <h2>Health</h2>
        </div>
        <div class="card-body" id="body-health">
          <div class="note" id="health-status">Loading…</div>
          <div class="note" id="health-last"></div>
          <div class="note" id="health-next"></div>
          <div class="note" id="health-calendar"></div>
          <div class="note" id="health-weather"></div>
          <div class="note" id="health-weather-detail"></div>
          <div class="note" id="health-error"></div>
          <button class="secondary" onclick="loadHealth()">Refresh health</button>
        </div>
      </div>
      </div>
    </div>
  </div>
  <div class="status" id="status">Loading…</div>

  <script>
    let currentState = {};
    const api = (path, opts={}) => {
      const url = path.startsWith('/') ? '.' + path : path;
      return fetch(url, opts);
    };
    const reflowGrid = () => {};
    const setStatus = (txt, ok=true) => {
      const el = document.getElementById('status');
      el.textContent = txt;
      el.style.background = ok ? 'rgba(50,255,140,0.08)' : 'rgba(255,64,64,0.15)';
    };

    function hydrate(st) {
      try {
        const ver = st.addon_version || '';
        const vEl = document.getElementById('ui-version');
        if (vEl) vEl.textContent = ver ? `v${ver}` : '';
        (document.getElementById('persona') || {}).value = st.persona_prompt || '';
        (document.getElementById('route_default') || {}).value = st.route_default || 'both';
        const ts = document.getElementById('throttle_seconds'); if (ts) ts.value = st.throttle_seconds ?? 0;
        const fe = document.getElementById('feed_enabled'); if (fe) fe.checked = !!st.feed_enabled;
        const ne = document.getElementById('notifications_enabled'); if (ne) ne.checked = !!st.notifications_enabled;
        const ns = document.getElementById('notify_service'); if (ns) ns.value = st.notify_service || '';
        const nt = document.getElementById('notify_title'); if (nt) nt.value = st.notify_title || '';
        const ng = document.getElementById('notify_tag'); if (ng) ng.value = st.notify_tag || '';
        const qs = document.getElementById('quiet_start'); if (qs) qs.value = st.quiet_hours_start || '22:00';
        const qe = document.getElementById('quiet_end'); if (qe) qe.value = st.quiet_hours_end || '07:00';
        const wg = document.getElementById('weather_gap'); if (wg) wg.value = st.weather_min_gap ?? 0;
        const wd = document.getElementById('weather_delta'); if (wd) wd.value = st.weather_temp_delta ?? 5;
        const wc = document.getElementById('weather_condition'); if (wc) wc.checked = st.weather_condition_change ?? true;
        const wf = document.getElementById('weather_feed_only_minor'); if (wf) wf.checked = st.weather_feed_only_minor ?? false;
        const wEnt = document.getElementById('weather_entity'); if (wEnt) wEnt.value = st.weather_entity || 'weather.home';
        const wSel = document.getElementById('weather_entity_select'); if (wSel) wSel.value = st.weather_entity || 'weather.home';
        const wp = document.getElementById('weather_poll'); if (wp) wp.value = st.weather_poll_interval ?? 300;
        const cl = document.getElementById('calendar_lead'); if (cl) cl.value = st.calendar_lead_minutes ?? 60;
        const cp = document.getElementById('calendar_poll'); if (cp) cp.value = st.calendar_poll_interval ?? 300;
        const cme = document.getElementById('calendar_morning_enabled'); if (cme) cme.checked = st.calendar_morning_enabled ?? true;
        const cmt = document.getElementById('calendar_morning_time'); if (cmt) cmt.value = st.calendar_morning_time || '07:30';
        const cee = document.getElementById('calendar_evening_enabled'); if (cee) cee.checked = st.calendar_evening_enabled ?? false;
        const cet = document.getElementById('calendar_evening_time'); if (cet) cet.value = st.calendar_evening_time || '21:00';
        const cats = st.categories || {};
        const feedCats = st.feed_categories || {};
        ['weather','trivia','calendar','system','vacuum','lighting','arrivals','people','musings','jokes'].forEach(cat => {
          const cEl = document.getElementById(`cat_${cat}`); if (cEl) cEl.checked = cats[cat] ?? true;
          const fEl = document.getElementById(`feed_${cat}`); if (fEl) fEl.checked = feedCats[cat] ?? true;
        });
        (document.getElementById('musing_min') || {}).value = st.musings_interval_min ?? 60;
        (document.getElementById('musing_max') || {}).value = st.musings_interval_max ?? 180;
        (document.getElementById('musing_cap') || {}).value = st.musings_daily_cap ?? 4;
        (document.getElementById('joke_min') || {}).value = st.jokes_interval_min ?? 120;
        (document.getElementById('joke_max') || {}).value = st.jokes_interval_max ?? 240;
        (document.getElementById('joke_cap') || {}).value = st.jokes_daily_cap ?? 3;
        (document.getElementById('musing_pool') || {}).value = (st.musing_pool || []).join('\\n');
        (document.getElementById('joke_pool') || {}).value = (st.joke_pool || []).join('\\n');
        (document.getElementById('news_urls') || {}).value = (st.news_urls || []).join('\\n');
        (document.getElementById('trivia_min') || {}).value = st.trivia_interval_min ?? 180;
        (document.getElementById('trivia_max') || {}).value = st.trivia_interval_max ?? 360;
        (document.getElementById('trivia_cap') || {}).value = st.trivia_daily_cap ?? 3;
        const tp = document.getElementById('trivia_pool'); if (tp) tp.value = (st.trivia_pool || []).join('\\n');
        const tu = document.getElementById('trivia_urls'); if (tu) tu.value = (st.trivia_urls || []).join('\\n');
        const calTxt = document.getElementById('calendar_entities'); if (calTxt) calTxt.value = (st.calendar_entities || []).join('\\n');
        const calSel = document.getElementById('calendar_entity_select');
        if (calSel) {
          const selected = (st.calendar_entities || []);
          Array.from(calSel.options).forEach((opt) => { opt.selected = selected.includes(opt.value); });
        }
        const ad = document.getElementById('arrival_delay'); if (ad) ad.value = st.arrival_emit_delay ?? 0;
        const ac = document.getElementById('arrival_combine'); if (ac) ac.value = st.arrival_combine_window ?? 300;
        const um = document.getElementById('unread-meta'); if (um) um.textContent = `Unread: ${st.unread_count ?? 0}`;
        const unread = st.unread_log || [];
        const ul = document.getElementById('unread-log'); if (ul) ul.textContent = unread.length ? `Unread log: ${unread.join(' | ')}` : '';
        const pauses = st.pauses || {};
        ['weather','calendar','trivia','system','vacuum','lighting','arrivals','people','musings','jokes'].forEach(cat => updatePauseButton(cat, pauses));
      } catch (err) {
        console.error('hydrate error', err);
        setStatus('Failed to load state.', false);
      }
      reflowGrid();
    }

    function collectState() {
      const categories = {
        weather: document.getElementById('cat_weather').checked,
        trivia: document.getElementById('cat_trivia').checked,
        calendar: document.getElementById('cat_calendar').checked,
        system: document.getElementById('cat_system').checked,
        vacuum: document.getElementById('cat_vacuum').checked,
        lighting: document.getElementById('cat_lighting').checked,
        arrivals: document.getElementById('cat_arrivals').checked,
        people: document.getElementById('cat_people').checked,
        musings: document.getElementById('cat_musings').checked,
        jokes: document.getElementById('cat_jokes').checked
      };
      const feed_categories = {
        weather: document.getElementById('feed_weather').checked,
        trivia: document.getElementById('feed_trivia').checked,
        calendar: document.getElementById('feed_calendar').checked,
        system: document.getElementById('feed_system').checked,
        vacuum: document.getElementById('feed_vacuum').checked,
        lighting: document.getElementById('feed_lighting').checked,
        arrivals: document.getElementById('feed_arrivals').checked,
        people: document.getElementById('feed_people').checked,
        musings: document.getElementById('feed_musings').checked,
        jokes: document.getElementById('feed_jokes').checked
      };
      return {
        persona_prompt: document.getElementById('persona').value.trim(),
        route_default: document.getElementById('route_default').value,
        throttle_seconds: Number(document.getElementById('throttle_seconds').value) || 0,
        feed_enabled: document.getElementById('feed_enabled').checked,
        notifications_enabled: document.getElementById('notifications_enabled').checked,
        notify_service: document.getElementById('notify_service').value.trim(),
        notify_title: document.getElementById('notify_title').value.trim(),
        notify_tag: document.getElementById('notify_tag').value.trim(),
        quiet_hours_start: document.getElementById('quiet_start').value || '22:00',
        quiet_hours_end: document.getElementById('quiet_end').value || '07:00',
        weather_min_gap: Number(document.getElementById('weather_gap').value) || 0,
        weather_temp_delta: Number(document.getElementById('weather_delta').value) || 0,
        weather_condition_change: document.getElementById('weather_condition').checked,
        weather_feed_only_minor: document.getElementById('weather_feed_only_minor').checked,
        weather_entity: document.getElementById('weather_entity').value.trim() || 'weather.home',
        weather_poll_interval: Number(document.getElementById('weather_poll').value) || 300,
        trivia_interval_min: Number(document.getElementById('trivia_min').value) || 0,
        trivia_interval_max: Number(document.getElementById('trivia_max').value) || 0,
        trivia_daily_cap: Number(document.getElementById('trivia_cap').value) || 0,
        arrival_emit_delay: Number(document.getElementById('arrival_delay').value) || 0,
        arrival_combine_window: Number(document.getElementById('arrival_combine').value) || 0,
        calendar_lead_minutes: Number(document.getElementById('calendar_lead').value) || 0,
        calendar_poll_interval: Number(document.getElementById('calendar_poll').value) || 300,
        calendar_morning_enabled: document.getElementById('calendar_morning_enabled').checked,
        calendar_morning_time: document.getElementById('calendar_morning_time').value || '07:30',
        calendar_evening_enabled: document.getElementById('calendar_evening_enabled').checked,
        calendar_evening_time: document.getElementById('calendar_evening_time').value || '21:00',
        categories,
        feed_categories,
        musing_pool: document.getElementById('musing_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        joke_pool: document.getElementById('joke_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        trivia_pool: document.getElementById('trivia_pool').value.split('\\n').map(v => v.trim()).filter(Boolean),
        trivia_urls: document.getElementById('trivia_urls').value.split('\\n').map(v => v.trim()).filter(Boolean),
        news_urls: document.getElementById('news_urls').value.split('\\n').map(v => v.trim()).filter(Boolean),
        calendar_entities: document.getElementById('calendar_entities').value.split('\\n').map(v => v.trim()).filter(Boolean),
        musings_interval_min: Number(document.getElementById('musing_min').value) || 0,
        musings_interval_max: Number(document.getElementById('musing_max').value) || 0,
        musings_daily_cap: Number(document.getElementById('musing_cap').value) || 0,
        jokes_interval_min: Number(document.getElementById('joke_min').value) || 0,
        jokes_interval_max: Number(document.getElementById('joke_max').value) || 0,
        jokes_daily_cap: Number(document.getElementById('joke_cap').value) || 0
      };
    }

    async function saveState() {
      try {
        const res = await api('api/state', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(collectState())
        });
        if (!res.ok) throw new Error(`Save failed: ${res.status}`);
        currentState = await res.json();
        hydrate(currentState);
        setStatus('Saved settings.');
      } catch (err) {
        console.error(err);
        setStatus('Failed to save settings.', false);
      }
    }

    async function loadState() {
      try {
        const res = await api('api/state');
        if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        currentState = await res.json();
        hydrate(currentState);
        setStatus('Ready.');
      } catch (err) {
        console.error('loadState error', err);
        setStatus('Failed to load state.', false);
        currentState = currentState || {};
        hydrate(currentState);
      }
    }

    const fmtTime = (raw) => {
      const d = new Date(raw);
      if (!isNaN(d.getTime())) {
        return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
      }
      const m = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(raw.trim());
      if (!m) return raw;
      let h = parseInt(m[1], 10);
      const min = m[2];
      const ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12 || 12;
      return `${h}:${min} ${ampm}`;
    };

    async function loadFeed() {
      try {
        const res = await api('api/feed');
        if (!res.ok) throw new Error(`Feed fetch failed: ${res.status}`);
        const data = await res.json();
        const feed = document.getElementById('feed');
        if (!data.entries || data.entries.length === 0) {
          feed.innerHTML = '<div class="note">No entries.</div>';
          return;
        }
        const entries = data.entries.slice().reverse().map(line => {
          const parts = line.split(' · ');
          if (parts.length >= 3) {
            const [ts, tag, ...rest] = parts;
            const msg = rest.join(' · ');
            const t = fmtTime(ts);
            return `<div class="entry"><span style="color:#eaeaea;margin-right:6px;">@ ${t}</span><span style="background:rgba(50,255,140,0.18);color:#f8f8f8;padding:2px 4px;border-radius:3px;font-size:0.75rem;margin-right:6px;">${tag}</span><span>${msg}</span></div>`;
          }
          return `<div class="entry">${line}</div>`;
        }).join('');
        feed.innerHTML = entries;
      } catch (err) {
        console.error(err);
        setStatus('Failed to load feed.', false);
      } finally {
        reflowGrid();
      }
    }

    async function loadHealth() {
      try {
        const res = await api('api/health');
        if (!res.ok) throw new Error(`Health fetch failed: ${res.status}`);
        const data = await res.json();
        document.getElementById('health-status').textContent = `Status: ${data.status}`;
        const last = data.last_emit || {};
        if (last.time) {
          const t = new Date(last.time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
          document.getElementById('health-last').textContent = `Last emit: ${last.category || ''}/${last.topic || ''} via ${last.route || ''} at ${t}`;
        } else {
          document.getElementById('health-last').textContent = 'Last emit: none';
        }
        const nextM = data.next_musing_time ? new Date(data.next_musing_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const nextJ = data.next_joke_time ? new Date(data.next_joke_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const nextT = data.next_trivia_time ? new Date(data.next_trivia_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('health-next').textContent = `Next musings: ${nextM} | Next jokes: ${nextJ} | Next trivia: ${nextT}`;
        const cal = data.last_calendar_poll ? new Date(data.last_calendar_poll * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('health-calendar').textContent = `Last calendar poll: ${cal}`;
        const wTs = data.last_weather_time ? new Date(data.last_weather_time * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        const wGap = data.weather_min_gap ?? 'n/a';
        const wDelta = data.weather_temp_delta ?? 'n/a';
        const wCond = data.weather_condition_change ? 'yes' : 'no';
        document.getElementById('health-weather').textContent = `Last weather emit: ${wTs} | Min gap: ${wGap}s | ΔT: ${wDelta} | Cond change: ${wCond}`;
        const wp = data.last_weather_payload || {};
        document.getElementById('health-weather-detail').textContent = wp.condition ? `Last weather payload: ${wp.condition} @ ${wp.temperature}` : '';
        document.getElementById('health-error').textContent = data.last_error ? `Last error: ${data.last_error}` : '';
      } catch (err) {
        console.error(err);
        setStatus('Failed to load health.', false);
      } finally {
        reflowGrid();
      }
    }

    async function emit() {
      const payload = {
        topic: document.getElementById('emit_topic').value.trim() || 'general',
        category: document.getElementById('emit_category').value.trim() || 'system',
        context: document.getElementById('emit_context').value.trim() || 'All systems nominal.',
        route: document.getElementById('emit_route').value || 'default'
      };
      if (document.getElementById('emit_force').checked) {
        payload.force = true;
      }
      try {
        const res = await api('api/emit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok && res.status !== 202) throw new Error(data.detail || 'Emit failed');
        setStatus(data.status === 'throttled' ? 'Throttled.' : `Sent via ${data.route}.`);
        loadFeed();
      } catch (err) {
        console.error(err);
        setStatus('Emit failed.', false);
      }
    }

    async function markRead() {
      try {
        const res = await api('api/mark_read', { method: 'POST' });
        if (!res.ok) throw new Error(`mark_read failed: ${res.status}`);
        setStatus('Marked read.');
        loadState();
      } catch (err) {
        console.error(err);
        setStatus('Failed to mark read.', false);
      }
    }

    async function quickEmit(cat) {
      try {
        const res = await api('api/trigger', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: cat, force: cat === 'weather' })
        });
        const data = await res.json();
        if (!res.ok && res.status !== 202) throw new Error(data.detail || 'Trigger failed');
        setStatus(data.status === 'throttled' ? `Throttled (${cat}).` : `Triggered ${cat}.`);
        loadFeed();
      } catch (err) {
        console.error(err);
        setStatus('Quick trigger failed.', false);
      }
    }

    async function pauseCategory(cat, minutes) {
      try {
        const now = Date.now() / 1000;
        const pauses = currentState.pauses || {};
        const alreadyPaused = pauses[cat] && pauses[cat] > now;
        const targetMinutes = alreadyPaused ? 0 : minutes;
        const res = await api('api/pause', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: cat, minutes: targetMinutes })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Pause failed');
        const until = data.paused_until ? new Date(data.paused_until * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'cleared';
        setStatus(`Pause updated for ${cat}: ${until}`);
        const newPauses = currentState.pauses || {};
        if (data.paused_until && data.paused_until > 0) {
          newPauses[cat] = data.paused_until;
        } else {
          delete newPauses[cat];
        }
        currentState.pauses = newPauses;
        updatePauseButton(cat, newPauses);
      } catch (err) {
        console.error(err);
        setStatus('Pause update failed.', false);
      }
    }

    async function reloadTrivia() {
      try {
        setStatus('Reloading trivia…');
        const res = await api('api/trivia/reload', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Trivia reload failed');
        const loadedAt = data.loaded_at ? new Date(data.loaded_at * 1000).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : 'n/a';
        document.getElementById('trivia-meta').textContent = `Loaded ${data.count || 0} trivia items at ${loadedAt}. Fallback: /config/charles_trivia.txt (or built-in)`;
        setStatus('Trivia reloaded.');
      } catch (err) {
        console.error(err);
        setStatus('Failed to reload trivia.', false);
      }
    }

    function updatePauseButton(cat, pauses) {
      const btn = document.getElementById(`pause-${cat}`);
      if (!btn) return;
      const now = Date.now() / 1000;
      const until = (pauses && pauses[cat]) ? pauses[cat] : 0;
      const paused = until > now;
      btn.classList.toggle('muted-btn', paused);
      btn.textContent = paused ? 'Paused' : 'Pause';
      btn.title = paused ? `Paused until ${new Date(until * 1000).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' })}` : 'Pause for 60m';
    }

    async function loadEntities(domain) {
      try {
        const res = await api(`api/entities/${domain}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Fetch failed');
        const sel = domain === 'weather' ? document.getElementById('weather_entity_select') : document.getElementById('calendar_entity_select');
        const statusEl = domain === 'weather' ? document.getElementById('weather-entity-status') : document.getElementById('calendar-entity-status');
        if (!sel) return;
        sel.innerHTML = '';
        (data.entities || []).forEach((item) => {
          const opt = document.createElement('option');
          opt.value = item.entity_id;
          opt.textContent = item.name ? `${item.name} (${item.entity_id})` : item.entity_id;
          sel.appendChild(opt);
        });
        if (statusEl) statusEl.textContent = `Loaded ${data.entities?.length || 0} ${domain} entities.`;
        setStatus(`Loaded ${data.entities?.length || 0} ${domain} entities.`);
      } catch (err) {
        console.error(err);
        setStatus(`Failed to load ${domain} entities.`, false);
      }
    }

    function toggleDetails(kind) {
      const row = document.getElementById(`row-${kind}`);
      const btn = document.getElementById(`btn-${kind}`);
      if (!row) return;
      row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
      if (btn) btn.textContent = row.style.display === 'none' ? '▼' : '▲';
      requestAnimationFrame(reflowGrid);
    }

    function saveOrder() {
      return;
    }

    function initMuuri() {
      return;
    }

    let autoFeed = false;
    let feedInterval = null;
    function toggleAutoFeed() {
      autoFeed = true;
      loadFeed();
      if (feedInterval) clearInterval(feedInterval);
      feedInterval = setInterval(loadFeed, 15000);
    }

    initMuuri();
    window.addEventListener('resize', () => {});
    loadState().then(() => { loadFeed(); loadHealth(); toggleAutoFeed(); });
  </script>
</body>
</html>
